# Agent Rules - Technical Reference

> **Official Technical Reference - Strict Instructions for AI**
>
> This document defines strict and non-negotiable rules that all AIs must respect when generating, modifying, or maintaining this project. **No deviation is permitted.**

---

## 1. General Principles

### 1.1 Autonomy and Open Source
- ✅ **Project totally autonomous** and self-hosted
- ✅ **All tools must be open-source**
- ❌ **No proprietary SaaS** permitted
- ✅ **Data in France**, no transit through external services
- ✅ **Clean, readable, structured, coherent and typed code**
- ❌ **No unnecessary dependencies**
- ✅ **Long-term compatibility priority**
- ✅ **This document conventions always prevail**

### 1.2 Code Quality
- **Ultra strict TypeScript** (no `any` without valid reason)
- **ESLint + Prettier** configured and respected
- **Tests** mandatory (unit + e2e)
- **Documentation** kept up to date automatically
- **Security** by default (OWASP, rate-limit, strict CORS)

---

## 2. Standard Project Structure

```
project-name/
├── backend/          # NestJS API
├── frontend/         # React + Vite
├── infra/            # Docker Compose, deployment, monitoring
├── docs/             # Technical documentation
│   └── ai/           # Documentation for AI agents
├── .husky/           # Git hooks
├── .gitea/           # CI/CD workflows
│   └── workflows/
└── README.md
```

### 2.1 Mandatory Folders
- `backend/` : NestJS API with modular architecture
- `frontend/` : React application + TypeScript + Vite
- `infra/` : Docker configuration, deployment scripts, monitoring
- `docs/` : Technical documentation generated by AI
- `docs/ai/` : Agent workflow documentation

---

## 3. Backend - Mandatory Rules

### 3.1 Imposed Stack
- **Framework** : NestJS
- **Language** : TypeScript (strict mode)
- **ORM** : Drizzle
- **Database** : PostgreSQL
- **Cache/Queue** : Redis + BullMQ
- **Storage** : MinIO (S3-compatible)

### 3.2 Architecture
- ✅ **Modular architecture mandatory** (one module = one folder)
- ✅ **DTO + ValidationPipe** systematic
- ✅ **Drizzle migrations** automatic
- ✅ **Swagger/OpenAPI** : `backend/src/config/swagger.config.ts`

### 3.3 Mandatory Modules
- `auth` - Authentication
- `users` - User management
- `files` - File management
- `notifications` - Notifications
- `audit` - Audit logs
- `core` - Cross-cutting services

### 3.4 Mandatory Guards
- `AuthGuard` - Protected routes
- `RolesGuard` - Permission management
- `RateLimitGuard` - Rate-limit protection

### 3.5 Mandatory Middleware
- **Global rate-limit**
- **Strict CORS**
- **OWASP headers** (via reverse proxy)
- **Structured logger** (no console.log)

### 3.6 Backend Security
- ✅ **Strict CORS** configured
- ✅ **OWASP headers** via reverse proxy
- ❌ **No public routes** undocumented
- ❌ **No secrets** in code
- ✅ **Rate-limit** on all routes
- ✅ **Validation** of all inputs
- ✅ **Audit logs** for critical actions

### 3.7 Backend Tests
- ✅ **Unit tests** via Jest or Vitest
- ✅ **E2E tests** via Supertest or Playwright
- ✅ **Minimum one test** per module

---

## 4. Frontend - Mandatory Rules

### 4.1 Imposed Stack
- **Framework** : React 19+
- **Language** : TypeScript (strict)
- **Build** : Vite
- **UI** : Radix UI + Tailwind CSS
- **State** : TanStack Query (React Query)
- **Router** : Wouter or TanStack Router

### 4.2 Strict Conventions
- ✅ **Functional components only**
- ✅ **Hooks exclusive** (no classes)
- ❌ **No heavy libraries** unless necessary
- ✅ **Typed API client** via OpenAPI generated
- ✅ **Analytics wrapper** PostHog (trackEvent)

### 4.3 Frontend Structure
```
frontend/
├── src/
│   ├── components/    # Reusable components
│   ├── pages/         # Pages/screens
│   ├── hooks/         # Custom hooks
│   ├── lib/           # Utilities
│   ├── api/           # Generated API client
│   └── App.tsx
```

### 4.4 Frontend Tests
- ✅ **React Testing Library** for components
- ✅ **Playwright** for critical scenarios
- ✅ **Tests on key forms**

---

## 5. Database and Storage

### 5.1 PostgreSQL
- ✅ **One instance per project**
- ✅ **Management via Drizzle ORM**
- ✅ **Automatic encrypted backups** with AGE
- ✅ **Versioned migrations**
- ❌ **No clear identifiers**

### 5.2 Redis
- ✅ **Application cache**
- ✅ **Rate-limit storage**
- ✅ **BullMQ queues**
- ✅ **One instance per project**

### 5.3 MinIO (S3-compatible)
- ✅ **Object storage** for files
- ✅ **One bucket per project**
- ✅ **Access via secured credentials**

### 5.4 Strict AI Rules
- ❌ **Never clear identifiers**
- ✅ **Environment variables** mandatory
- ✅ **Consistent migrations** and documented

---

## 6. Authentication and SSO

### 6.1 Identity Provider
- **Platform** : Authentik (self-hosted)
- **Protocol** : OAuth2/OIDC
- **Integration** : Passport.js in NestJS

### 6.2 Mandatory Integration
- ✅ **OAuth2/OIDC** between Authentik and NestJS
- ✅ **Role management** via RolesGuard
- ❌ **Forbidden** to duplicate auth logic in frontend
- ✅ **Secured JWT tokens**

---

## 7. Emails and Notifications

### 7.1 Emailing
- **Platform** : Listmonk (self-hosted)
- **Usage** : API or CLI
- ❌ **Forbidden** to use Nodemailer directly

### 7.2 Internal Notifications
- **Platform** : Gotify (if needed)
- **Usage** : Push notifications for alerts

### 7.3 Strict Rules
- ✅ **All sends via Listmonk**
- ✅ **Email templates** versioned
- ❌ **No sensitive data** in emails

---

## 8. Observability and Logs

### 8.1 Mandatory Stack
- **Metrics** : Prometheus
- **Dashboards** : Grafana
- **Logs** : Loki + Promtail
- **Errors** : GlitchTip (Sentry OSS)

### 8.2 AI Rules
- ✅ **Reproducible Docker Compose** config
- ✅ **`/metrics` endpoint** exposed on backend
- ✅ **Structured logger** (Winston or Pino)
- ❌ **No console.log** in production

---

## 9. Product Analytics

### 9.1 Imposed Tool
- **Platform** : PostHog OSS (self-hosted)

### 9.2 Strict Rules
- ✅ **`trackEvent` wrapper** mandatory
- ✅ **Limited instrumentation** to critical business events
- ❌ **No sensitive data** sent
- ✅ **GDPR compliant**

---

## 10. CI/CD - Mandatory Rules

### 10.1 Platform
- **Git** : Gitea (self-hosted)
- **CI/CD** : Gitea Actions or Woodpecker CI

### 10.2 Minimal Pipeline
```yaml
1. Installation (npm ci)
2. Lint (eslint + prettier)
3. Tests (unit + e2e)
4. Build (backend + frontend)
5. Build Docker
6. Deployment (via deploy.sh)
```

### 10.3 CI/CD Security
- ✅ **Encrypted secrets** via SOPS + AGE
- ❌ **No secrets in logs**
- ✅ **Blocking** on TypeScript/ESLint errors
- ✅ **Mandatory tests** before merge

---

## 11. Secrets - SOPS + AGE

### 11.1 Strict AI Rules
- ✅ **All secrets** in `.env.sops`
- ❌ **No sensitive variables** in clear
- ✅ **AGE encryption** mandatory
- ✅ **Decryption only** in CI/CD or server

### 11.2 Forbidden Clear Variables
- Database credentials
- API keys
- JWT secrets
- OAuth credentials
- SMTP passwords
- Storage access keys

---

## 12. Tests and Quality

### 12.1 Minimum Obligations
- ✅ **One unit test** per backend module
- ✅ **Playwright e2e tests** on 3 business flows
- ✅ **RTL tests** for key forms
- ✅ **Test coverage** must not decrease

### 12.2 Quality Metrics
- **TypeScript** : 0 errors (strict)
- **ESLint** : 0 critical errors
- **Cyclomatic complexity** : <= 20
- **Max depth** : <= 4 levels
- **Lines per function** : <= 150
- **Function parameters** : <= 6

---

## 13. Security - Strict Rules

### 13.1 AI Must Always
- ✅ Apply **strict rate-limit**
- ✅ Lock down **CORS**
- ✅ Create **necessary Guards**
- ✅ Generate **audit logs**
- ✅ Secure **all routes** by default
- ❌ Forbid **any non-open-source dependency**

### 13.2 Security Checklist
- [ ] Rate-limit configured
- [ ] Strict CORS
- [ ] Auth/roles guards in place
- [ ] Input validation
- [ ] Audit logs
- [ ] OWASP headers
- [ ] Encrypted secrets
- [ ] No possible injection (SQL, XSS, Command)

---

## 14. Generated Documentation

### 14.1 Mandatory Files

AI must generate and maintain:

```
docs/
├── README.md                    # Project overview
├── ARCHITECTURE.md              # Detailed architecture
├── API_DOCS.md                  # API documentation
├── SECURITY.md                  # Security & best practices
├── RUNBOOK.md                   # Operational guide
└── ai/
    ├── AGENT_CHECKLIST.md       # Agent workflow contract
    ├── AGENT_RULES.md           # Technical rules (this file)
    ├── AGENT_STATUS.yaml        # Machine-readable status
    └── PROJECT_CONTEXT.md       # Project context
```

### 14.2 Format
- **Markdown** for human readability
- **YAML** for automatic parsing
- **ASCII schemas** if no diagrams
- **Automatic updates** on each change

---

## 15. Strict Summary for AI

### At Each Operation, AI Must

1. ✅ **Follow imposed stack strictly**
2. ✅ **Update documentation** on each change
3. ❌ **Never introduce** unencrypted secrets
4. ✅ **Prefer functional simplicity**
5. ✅ **Respect modular architecture**
6. ✅ **Check long-term coherence** before coding
7. ✅ **Use TodoWrite** for tasks > 3 steps
8. ✅ **Read before write** with Read tool
9. ✅ **Verify TypeScript + ESLint** systematically
10. ✅ **Respect 5 phases** (AGENT_CHECKLIST.md)

---

## 16. Absolute Prohibitions

### Never

1. Modify file without reading first
2. Use `@ts-ignore`/`@ts-expect-error` without justification
3. Commit secrets/credentials
4. Disable ESLint to hide errors
5. Over-engineer (stay simple and focused)
6. Create unnecessary files
7. Use `any` without valid reason
8. Skip existing tests
9. Use proprietary SaaS tools
10. Expose sensitive data

---

## 17. Absolute Obligations

### Always

1. Use TodoWrite for tasks > 3 steps
2. Read before write with Read
3. Verify TypeScript (`npm run check`)
4. Verify ESLint (`npm run lint`)
5. Test modifications
6. Document complex choices
7. Respect project conventions
8. Finalize todos (mark completed)
9. Follow 5 phases (AGENT_CHECKLIST.md)
10. Update AGENT_STATUS.yaml

---

## 18. Workflow Contract

This document is a **technical contract** between developers and AI agents.

**By following these rules, the agent commits to**:
- ✅ Produce production-quality code
- ✅ Respect security standards
- ✅ Maintain architectural coherence
- ✅ Document decisions
- ✅ Never compromise stability

**Sanctions for non-compliance**:
- Code rejection
- Rollback of modifications
- Mandatory manual review

---

**Version** : 1.0.0
**Date** : 12 December 2025
**Status** : Active and mandatory
**Review** : Quarterly or on demand

---

**Note** : This document takes precedence over any alternative suggestion. When in doubt, ask for clarification before acting.
