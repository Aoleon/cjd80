# ===================================
# Docker Compose pour production optimisé
# Inclut des configurations de sécurité et robustesse renforcées
# ===================================
version: '3.8'

services:
  cjd-app:
    image: ${DOCKER_IMAGE:-cjd80:latest}
    container_name: cjd-app
    restart: unless-stopped
    
    # Configuration réseau
    expose:
      - "5000"
    
    # Variables d'environnement
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: 5000
    
    # Labels Traefik pour routage et SSL
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      
      # Router HTTP -> HTTPS redirect
      - "traefik.http.routers.cjd80.rule=Host(`cjd80.fr`)"
      - "traefik.http.routers.cjd80.entrypoints=websecure"
      - "traefik.http.routers.cjd80.tls=true"
      - "traefik.http.routers.cjd80.tls.certresolver=letsencrypt"
      
      # Service configuration
      - "traefik.http.services.cjd80.loadbalancer.server.port=5000"
      
      # Health check pour Traefik
      - "traefik.http.services.cjd80.loadbalancer.healthcheck.path=/api/health/ready"
      - "traefik.http.services.cjd80.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.cjd80.loadbalancer.healthcheck.timeout=5s"
      
      # Middleware de sécurité (optionnel)
      - "traefik.http.routers.cjd80.middlewares=security-headers@file"
    
    # Health check Docker natif
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5000/api/health/ready"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    
    # Volumes pour persistance
    volumes:
      - ./logs:/app/logs:rw
      # Volume pour les données temporaires si nécessaire
      - app-tmp:/tmp:rw
    
    # Réseaux
    networks:
      - proxy               # Réseau externe Traefik
      - cjd-network         # Réseau interne
      - supabase-network-prod  # Réseau Supabase
    
    # Limites de ressources (adaptées à votre serveur)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      
      # Politique de redémarrage
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      
      # Update config pour le rolling update
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
    
    # Configuration de logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=cjd-app"
    
    # Sécurité
    security_opt:
      - no-new-privileges:true
    
    # Capabilities limitées (si nécessaire)
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    
    # Read-only filesystem (optionnel, nécessite des volumes pour les writes)
    # read_only: true
    
    # User namespacing (si configuré sur le host)
    # userns_mode: "host"
    
    # Stop configuration pour graceful shutdown
    stop_grace_period: 30s
    stop_signal: SIGTERM

# Volumes
volumes:
  app-tmp:
    driver: local

# Réseaux
networks:
  # Réseau externe Traefik (doit exister)
  proxy:
    external: true
  
  # Réseau interne pour l'application
  cjd-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  
  # Réseau Supabase (doit exister)
  supabase-network-prod:
    external: true
