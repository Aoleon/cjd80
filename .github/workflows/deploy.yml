name: Deploy to VPS

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Precheck secrets (bash)
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          missing=0
          for v in VPS_SSH_KEY VPS_HOST VPS_PORT VPS_USER; do
            if [ -z "${!v}" ]; then echo "::error::Missing secret: $v"; missing=1; fi
          done
          [ "$missing" -eq 0 ]

      - name: Start ssh-agent & add key (fix CRLF)
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          eval "$(ssh-agent -s)"
          printf '%s\n' "$VPS_SSH_KEY" | tr -d '\r' | ssh-add - <<<"$VPS_SSH_KEY" 2>/dev/null || \
          ( printf '%s\n' "$VPS_SSH_KEY" | tr -d '\r' | ssh-add - )

      - name: Trust VPS host key
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "$VPS_PORT" "$VPS_HOST" >> ~/.ssh/known_hosts

      - name: Deploy on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh -p "$VPS_PORT" "$VPS_USER@$VPS_HOST" "bash /docker/cjd80/deploy.sh"
