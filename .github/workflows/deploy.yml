name: Deploy to VPS

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Timeout global Ã©tendu pour les builds longs
    steps:
      - name: Precheck secrets
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST_FINGERPRINT: ${{ secrets.VPS_HOST_FINGERPRINT }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPO_OWNER: ${{ secrets.GH_REPO_OWNER }}
          GH_REPO_NAME: ${{ secrets.GH_REPO_NAME }}
        run: |
          set -e
          for v in VPS_SSH_KEY VPS_HOST VPS_PORT VPS_USER VPS_HOST_FINGERPRINT GH_TOKEN GH_REPO_OWNER GH_REPO_NAME; do
            if [ -z "${!v}" ]; then echo "::error::Missing secret: $v"; exit 1; fi
          done
          echo "âœ… Tous les secrets requis sont configurÃ©s"

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          fingerprint: ${{ secrets.VPS_HOST_FINGERPRINT }}
          command_timeout: 45m  # AlignÃ© sur le timeout global
          script: |
            set -e
            
            # Heartbeat pour Ã©viter les timeouts GitHub Actions
            (while sleep 60; do echo "[keepalive] $(date)"; done) &
            HEARTBEAT_PID=$!
            trap "kill $HEARTBEAT_PID 2>/dev/null || true" EXIT
            
            export GITHUB_TOKEN="${{ secrets.GH_TOKEN }}"
            export GITHUB_REPO_OWNER="${{ secrets.GH_REPO_OWNER }}"
            export GITHUB_REPO_NAME="${{ secrets.GH_REPO_NAME }}"
            
            echo "ðŸš€ DÃ©but du dÃ©ploiement..."
            bash /docker/cjd80/deploy.sh
            
            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s"

      - name: Cleanup old Docker containers & images on VPS
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          fingerprint: ${{ secrets.VPS_HOST_FINGERPRINT }}
          command_timeout: 10m  # 10 minutes pour le nettoyage
          script: |
            echo 'ðŸ§¹ Nettoyage des vieux conteneurs et images...'
            # Nettoyage conservateur pour prÃ©server le cache Docker
            docker container prune -f
            docker image prune -f  # Supprime seulement les images "dangling"
            docker volume prune -f
            echo 'âœ… Nettoyage terminÃ©'
