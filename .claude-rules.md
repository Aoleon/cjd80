# Règles d'Engagement IA - CJD80

## Imports Règles Globales

Ce projet hérite de toutes les règles globales :

**Hiérarchie des règles (de la plus prioritaire à la moins) :**
1. **Ce fichier** (.claude-rules.md) - Règles spécifiques CJD80
2. `~/.claude/rules/10-infrastructure.md` - Protection infrastructure
3. `~/.claude/rules/00-global.md` - Règles globales
4. `~/.claude/rules/99-agents-verification.md` - Protocoles vérification

**IMPORTANT:** Les règles de ce fichier PRIMENT sur les règles globales en cas de conflit.

---

## Statut Projet

**Environnement:** Production + Development ✅
**Priorité actuelle:** Stabilité & migration NestJS complète
**Niveau criticité:** MOYENNE (application métier interne)
**Protection infrastructure:** STANDARD avec vigilance migration
**URLs:**
- **Production:** https://cjd80.fr
- **Development:** http://cjd80.rbw.ovh ou http://localhost

---

## Règles Spécifiques CJD80

### 1. Migration NestJS - État Actuel (Janvier 2025)

#### Status
- ✅ Backend migré de Express.js vers NestJS 11
- ✅ Modules organisés par feature (11 modules)
- ✅ Dependency injection implémentée
- ✅ Database (Drizzle ORM) intégrée
- ✅ Authentik OAuth2 configuré
- ✅ Services self-hosted (PostgreSQL, MinIO, Redis, Authentik)
- ⚠️ Frontend en transition : Next.js + React (au lieu de Vite)
- À déterminer: Impact complet testing E2E

#### Patterns à Respecter

**TOUJOURS suivre patterns NestJS :**

```typescript
// ✅ Module structure
@Module({
  controllers: [IdeaController],
  providers: [IdeaService],
})
export class IdeaModule {}

// ✅ Service avec DI
@Injectable()
export class IdeaService {
  constructor(
    @Inject('DB') private db: Database,
    private readonly authService: AuthService
  ) {}

  async findAll() {
    return this.db.query.ideas.findMany();
  }
}

// ✅ Controller avec guards
@Controller('api/ideas')
@UseGuards(AuthGuard)
export class IdeaController {
  constructor(private ideaService: IdeaService) {}

  @Get()
  async findAll() {
    return this.ideaService.findAll();
  }

  @Post()
  @UseGuards(PermissionGuard)
  @Permissions('super_admin', 'ideas_manager')
  async create(@Body() dto: CreateIdeaDto) {
    return this.ideaService.create(dto);
  }
}
```

### 2. TypeScript Strict Mode - Obligatoire

#### Règles

- **Strict mode:** TOUJOURS activé (`tsconfig.json` et `tsconfig.server.json`)
- **No `any` types:** AUCUNE exception
- **Vérification obligatoire:** `npm run check` avant tout commit
- **Erreurs TypeScript:** ZÉRO tolérance

#### Vérification

```bash
# Avant commit
npm run check

# Sortie attendue:
# ✓ tsc -p tsconfig.json
# ✓ tsc -p tsconfig.server.json
# Exit code: 0 (succès)
```

**Si erreurs détectées:**
1. Lister CHAQUE erreur avec fichier:ligne
2. NE PAS ignorer warnings "mineurs"
3. NE PAS commit si erreurs TS

### 3. Database - Drizzle ORM Patterns

#### Règles

- **Query builders:** Préférer TOUJOURS aux raw SQL
- **Type safety:** Utiliser inferred types de schema
- **Transactions:** Pour opérations multi-tables
- **Schema:** `shared/schema.ts` = source unique de vérité
- **Migrations:** `npm run db:push` AVANT merge

#### Pattern Requis

```typescript
// ✅ BON - Query builders
import { db } from '@/common/database/database.providers';
import { ideas, eq } from '@shared/schema';

const result = await db
  .select()
  .from(ideas)
  .where(eq(ideas.status, 'PENDING'));

// ✅ BON - Insert avec returning
const newIdea = await db
  .insert(ideas)
  .values({ title, description })
  .returning();

// ❌ INTERDIT - Raw SQL
const result = await db.execute(sql`SELECT * FROM ideas WHERE status = 'PENDING'`);
```

#### Migration Database

**JAMAIS directement en production:**

```bash
# 1. Backup database
npm run db:backup

# 2. Test en local/staging
npm run db:push

# 3. Vérifier schema
npm run db:stats

# 4. Appliquer en production (avec plan si infra)
```

### 4. Code Quality - Standards Stricts

#### NestJS Patterns

- **Dependency Injection:** Constructor-based uniquement
- **DTOs:** class-validator decorators obligatoires (si utilisation)
- **Guards/Interceptors:** Appliqués au niveau approprié
- **Services:** Business logic UNIQUEMENT dans services
- **Modules:** Organisation modulaire stricte
- **Exception Handling:** Utiliser HTTP exceptions standard

#### Frontend React/Next.js Patterns

- **Custom Hooks:** Pour TOUTE data fetching (TanStack Query)
- **Invalidation:** Après CHAQUE mutation
- **Error Handling:** Gérer loading/error/success states
- **Forms:** React Hook Form + Zod UNIQUEMENT
- **Components:** Fonctionnels avec hooks (pas class components)

#### Exemple Composant Frontend

```typescript
// ✅ BON
export function IdeaList() {
  // 1. State
  const [filters, setFilters] = useState<IdeaFilters>({ status: 'PENDING' });

  // 2. Data fetching
  const { data: ideas, isLoading, isError } = useIdeas(filters);

  // 3. Mutations
  const voteIdea = useMutation({
    mutationFn: async (ideaId: string) => {
      const res = await fetch(`/api/ideas/${ideaId}/vote`, { method: 'POST' });
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/ideas'] });
    }
  });

  // 4. Loading state
  if (isLoading) return <Spinner />;
  if (isError) return <ErrorMessage />;

  // 5. Render
  return (
    <div>
      {ideas.map(idea => (
        <IdeaCard
          key={idea.id}
          idea={idea}
          onVote={() => voteIdea.mutate(idea.id)}
        />
      ))}
    </div>
  );
}
```

### 5. Authentication & Authorization

#### Authentik Integration

- **OAuth2 Flow:** Implémenté via `server/src/auth/strategies/authentik.strategy.ts`
- **Session Store:** PostgreSQL (connect-pg-simple)
- **Sync Users:** Automatique à chaque login
- **Group Mapping:** Groups Authentik → Roles application

#### Patterns Protégés

```typescript
// ✅ Public endpoint
@Controller('api/ideas')
export class IdeaPublicController {
  @Get()
  async listPublic() { }
}

// ✅ Protected - Auth required
@Controller('api/ideas')
@UseGuards(AuthGuard)
export class IdeaProtectedController {
  @Get('my')
  async myIdeas(@User() user: Admin) { }
}

// ✅ Protected - Role-based
@Controller('api/admin/ideas')
@UseGuards(AuthGuard)
export class IdeaAdminController {
  @Delete(':id')
  @UseGuards(PermissionGuard)
  @Permissions('super_admin')
  async delete(@Param('id') id: string) { }
}
```

**NE PAS modifier:**
- OAuth2 flow sans test complet
- Session store configuration
- Authentik strategy sans validation user sync

### 6. Semantic Colors System

#### Règles

- **Utiliser classes sémantiques** au lieu de couleurs hardcoded
- **Variants:** Dark/light available pour chaque couleur
- **Configuration:** Admin peut modifier 17 couleurs via `/admin/branding`

#### Pattern Requis

```tsx
// ✅ BON - Semantic colors
<div className="bg-success">Success</div>
<div className="text-error">Error</div>
<div className="border-warning">Warning</div>
<div className="bg-success-dark">Dark Success</div>

// ❌ MAUVAIS - Hardcoded Tailwind
<div className="bg-green-500">Success</div>
<div className="text-red-500">Error</div>
```

**Couleurs Disponibles:**
- `success`, `success-dark`, `success-light`
- `error`, `error-dark`, `error-light`
- `warning`, `warning-dark`, `warning-light`
- `info`, `info-dark`, `info-light`

### 7. Shared Schema & Status Constants

#### Règles

- **Schema:** `shared/schema.ts` = source unique de vérité
- **Constants:** Toujours utiliser constants de schema
- **Validation:** Zod schemas partagés frontend/backend

#### Pattern Requis

```typescript
// ✅ BON
import { IDEA_STATUS, ideas } from '@shared/schema';

if (idea.status === IDEA_STATUS.APPROVED) { /* ... */ }

const ideas = db.query.ideas.findMany({
  where: eq(ideas.status, IDEA_STATUS.PENDING)
});

// ❌ MAUVAIS
if (idea.status === 'APPROVED') { /* ... */ }
const ideas = db.query.ideas.findMany({
  where: eq(ideas.status, 'PENDING')
});
```

**Constants Disponibles:**
- `IDEA_STATUS` (PENDING, APPROVED, REJECTED, ARCHIVED)
- `EVENT_STATUS` (DRAFT, PUBLISHED, CLOSED, CANCELLED)
- `LOAN_STATUS` (AVAILABLE, BORROWED, RETURNED, DAMAGED)
- `ADMIN_ROLES` (SUPER_ADMIN, ideas_manager, events_manager, finance_manager)

### 8. PWA & Service Workers

#### Règles

- **Offline Queue:** Basé IndexedDB pour actions offline
- **Service Workers:** `client/public/sw.js` + `client/public/sw-register.js`
- **Push Notifications:** Via Web Push API avec VAPID
- **Installation:** Web app installable comme native
- **Manifest:** Généré via `npm run generate:config`

#### NE PAS modifier:
- Service worker registration pattern sans testing offline
- Push notification encryption
- PWA manifest generation sans validation

### 9. Branding System

#### Configuration Centralisée

- **Config File:** `client/src/config/branding-core.ts`
- **Admin Interface:** `/admin/branding` (SUPER_ADMIN)
- **Generation:** `npm run generate:config` crée index.html + manifest.json
- **17 Couleurs:** Configurables via admin

#### Pattern

```typescript
// ✅ BON - Utiliser config branding
import { getBrandingConfig } from '@/lib/branding';

const config = getBrandingConfig();
const logoUrl = config.logos.main;
const accentColor = config.colors.primary;

// ❌ MAUVAIS - Hardcoded branding
const logoUrl = '/logos/cjd-amiens.png';
const accentColor = '#007bff';
```

**NE PAS modifier branding-core.ts directement** - utiliser admin interface.

### 10. Docker & Deployment

#### Services Requis

**Toujours vérifier running:**
```bash
docker compose -f docker-compose.services.yml ps

# Output expected:
# cjd-postgres     ✓ healthy
# cjd-minio        ✓ healthy
# cjd-redis        ✓ healthy
# cjd-authentik    ✓ running
```

#### Production Deployment

**Domaine:** `cjd80.fr`
**Reverse Proxy:** Traefik (via docker-compose.yml)
**SSL:** Let's Encrypt (auto)
**Health Check:** `/api/health` endpoint

#### Logs & Monitoring

```bash
# Container logs
docker logs cjd-app          # Application
docker logs cjd-postgres     # Database
docker logs cjd-minio        # Object storage
docker logs cjd-redis        # Cache
docker logs cjd-authentik    # Auth provider

# Health check
npm run health
npm run health:check
```

### 11. Testing & Validation

#### Unit Tests

**Framework:** Vitest
```bash
npm test              # Run tests
npm run test:watch    # Watch mode
npm run test:coverage # Coverage report
```

**Services Critiques à Tester:**
- Authentik user sync
- Idea creation/voting logic
- Event registration
- Financial calculations

#### E2E Tests (Playwright)

```bash
npm run test:playwright   # Run E2E
npm run test:analyze      # Analyze results
npm run test:maintenance  # Maintenance mode
```

**Critical Flows à Tester:**
1. Login via Authentik
2. Créer idée + voter
3. Créer événement + s'inscrire
4. Admin: gérer permissions
5. PWA: offline mode

#### Pre-Commit Validation

```bash
# TypeScript check (OBLIGATOIRE)
npm run check          # Must exit 0

# Linting
npm run lint           # If configured

# Tests si modifications critiques
npm test              # Services critic only
```

### 12. Git & Versioning

#### Commits

- **Format:** `type: description` (français)
- **Types:**
  - `feat:` - Nouvelle feature
  - `fix:` - Correction bug
  - `refactor:` - Refactoring (pas changement features)
  - `perf:` - Optimisation performance
  - `docs:` - Documentation
  - `chore:` - Maintenance

#### Exemples Valides

```
feat: ajouter système de vote pour idées
fix: corriger synchronisation user Authentik
refactor: extraire logique idée en service
docs: documenter branding system
chore: mettre à jour dépendances
```

#### Branches

- **Main:** `main` (production)
- **Features:** `feature/nom-feature`
- **Fixes:** `fix/description-bug`
- **Releases:** Tags `v1.2.3`

#### Pre-Commit Checks

- ✅ `npm run check` - TypeScript strict
- ✅ Pas de `any` types
- ✅ Secrets jamais en code (.env in .gitignore)
- ✅ Messages commit français

### 13. Performance

#### Frontend

- **Bundle Size:** Target < 400KB gzipped
- **Lazy Loading:** Routes + components lourds
- **Memoization:** useCallback/useMemo pour calculs coûteux
- **Images:** Optimisation (Next.js Image component)
- **Code Splitting:** Automatique via Next.js

#### Backend

- **Database Queries:** Indexes sur colonnes fréquentes
- **N+1 Queries:** Éviter via Drizzle joins
- **Caching:** Redis pour données fréquentes
- **Rate Limiting:** Protection endpoints publics
- **Logging:** Structured logging pour observabilité

### 14. Environment Variables

#### Sécurité

- **JAMAIS hardcoded** dans le code
- **JAMAIS committés** (.env dans .gitignore)
- **Rotation:** Régulière en production
- **Sensitive Data:** Jamais loggés

#### Validation

```bash
# Vérifier env valide
npm run validate:env

# Affiche erreurs si variables manquantes
```

---

## Agents Recommandés pour CJD80

### Agent Principal - Haiku (Default)
**Usage:** Exploration codebase, analyses, lectures fichiers, modifications standards

Recommandé pour :
- Explorer architecture NestJS
- Analyser schema database
- Lire configurations
- Implémenter features standards

### Agent Debug - TypeScript (Haiku)
**Usage:** Erreurs TypeScript, type safety, refactoring

Recommandé pour :
- Fixer erreurs TS
- Améliorer type safety
- Migrations types
- Validation strict mode

### Agent Frontend - React Hooks (Haiku)
**Usage:** Composants React, TanStack Query, forms

Recommandé pour :
- Composants UI (Radix + Tailwind)
- Custom hooks
- Forms React Hook Form
- State management TanStack Query

### Agent Infrastructure - NestJS (Haiku si standard, Sonnet si complexe)
**Usage:** Modifications services, modules, database

Recommandé pour :
- Créer new modules NestJS
- Ajouter tables database
- Intégrations services
- Patterns DI complexes

---

## Interdictions Formelles CJD80

### JAMAIS sans Plan Détaillé
- Modifier docker-compose (services, config)
- Redémarrer containers production (restart/down/up)
- Migrer base de données production
- Modifier Authentik configuration
- Mettre à jour dépendances majeures

### JAMAIS sans Tests
- Modifier auth flow OAuth2
- Changer schema database
- Refactorer services critiques (ideas, auth, finance)
- Modifier business logic sensible

### JAMAIS Commit
- Code avec erreurs TypeScript
- Code avec `any` types
- Secrets en dur (utiliser .env)
- `node_modules/`
- `.env` réel (seulement `.env.example`)

### JAMAIS Modifier
- Branding system sans passing par admin interface
- Session store configuration
- Authentik strategy sans validation complete
- Service worker patterns sans testing offline

---

## Checklist Avant Modification

Avant TOUTE modification code/infrastructure :

- [ ] Contexte CJD80 chargé (CLAUDE.md + .claude-stack.md)
- [ ] TypeScript strict mode vérifié (`npm run check`)
- [ ] Migration NestJS patterns respectés
- [ ] Tests écrits/mis à jour si logic critique
- [ ] Drizzle ORM patterns suivis (pas raw SQL)
- [ ] Semantic colors utilisés (pas hardcoded)
- [ ] Git message format français respecté
- [ ] Validation post-modification planifiée

---

## Vérifications Post-Modification

Après CHAQUE modification, vérifier :

```bash
# 1. TypeScript
npm run check            # Exit 0 obligatoire

# 2. Tests (si critiques)
npm test                 # Doit passer

# 3. Database (si schema change)
npm run db:stats         # Vérifier tables
npm run db:connect       # Vérifier connexion

# 4. Services
docker compose -f docker-compose.services.yml ps  # Tous healthy

# 5. Application
npm run start:dev        # Peut démarrer sans erreurs
npm run health:check     # Health endpoints OK
```

---

## Gestion des Erreurs

### TypeScript Errors

```
❌ Trouvé erreur TypeScript
Fichier: server/src/ideas/ideas.service.ts:42
Type: Argument of type 'string' is not assignable to parameter of type 'IdeaStatus'

Action:
1. Utiliser constant de schema: IDEA_STATUS.PENDING
2. Ou utiliser type inferred: typeof ideas.$inferSelect
3. Vérifier tsconfig.json strict mode
4. Relancer npm run check
```

### Database Errors

```
❌ Migration failure
Error: "relation 'ideas' does not exist"

Action:
1. Vérifier schema.ts modifié
2. Lancer npm run db:push
3. Vérifier DATABASE_URL correct
4. Check docker compose service healthy
```

### NestJS Errors

```
❌ Module import error
NestJS Error: "Cannot find module 'IdeaService'"

Action:
1. Vérifier IdeaModule importe IdeaService
2. Vérifier providers dans @Module()
3. Vérifier import dans app.module.ts
4. Relancer app
```

---

## En Cas de Doute

**TOUJOURS privilégier :**
1. Demander validation utilisateur si modifications importantes
2. Créer plan détaillé pour infrastructure changes
3. Consulter CLAUDE.md patterns si incertitude
4. Déléguer à agent spécialisé si complexe
5. Sur-communiquer plutôt que sous-communiquer

**JAMAIS :**
- Assumer patterns sans vérifier dans codebase
- Modifier sans `npm run check` validation
- Commit avec erreurs TypeScript
- Ignorer warnings "mineurs"

---

## Ressources Importantes

**Fichiers Clés:**
- `CLAUDE.md` - Patterns détaillés & bonnes pratiques
- `.claude-stack.md` - Stack technique complète
- `README.md` - Documentation projet
- `docs/` - Documentation technique

**Commandes Essentielles:**
- `npm run check` - Validation TypeScript
- `npm run db:push` - Migrations
- `npm run start:dev` - Dev complet
- `docker compose -f docker-compose.services.yml ps` - Services status

---

**Rappel:** CJD80 est une application production pour métier interne. Priorité à la stabilité et migration NestJS complète.

