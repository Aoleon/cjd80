# Règles d'Engagement IA - CJD Amiens "Boîte à Kiffs"

## Development Patterns

### Creating a New NestJS Module

1. **Generate with NestJS CLI:**
   ```bash
   npx nest generate module features/my-feature --no-spec
   npx nest generate controller features/my-feature --no-spec
   npx nest generate service features/my-feature --no-spec
   ```

2. **Define schema in `shared/schema.ts`:**
   ```typescript
   export const myFeatures = pgTable("my_features", {
     id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
     title: text("title").notNull(),
     createdAt: timestamp("created_at").defaultNow().notNull()
   });

   export const insertMyFeatureSchema = createInsertSchema(myFeatures);
   ```

3. **Create service with DB injection:**
   ```typescript
   @Injectable()
   export class MyFeatureService {
     constructor(@Inject('DB') private db: Database) {}

     async findAll() {
       return this.db.query.myFeatures.findMany();
     }
   }
   ```

4. **Create controller with guards:**
   ```typescript
   @Controller('api/my-features')
   export class MyFeatureController {
     constructor(private myFeatureService: MyFeatureService) {}

     @Get()
     @UseGuards(AuthGuard)  // Require authentication
     async findAll() {
       return this.myFeatureService.findAll();
     }
   }
   ```

5. **Import module in `app.module.ts`**

### Adding a Database Table

1. **Define in `shared/schema.ts`** with Drizzle schema
2. **Add indexes** for frequently queried columns
3. **Create Zod validation schemas** using `createInsertSchema()`
4. **Run `npm run db:push`** to apply changes
5. **Update TypeScript types** (auto-inferred from schema)

### Authentication and Authorization

**Pattern for protected routes:**
```typescript
@Controller('api/admin/features')
@UseGuards(AuthGuard)  // Session-based auth
export class AdminFeatureController {
  @Get()
  @Permissions('super_admin', 'ideas_manager')  // Role-based permissions
  @UseGuards(PermissionGuard)
  async findAll() { ... }
}
```

**Getting current user:**
```typescript
@Get('profile')
@UseGuards(AuthGuard)
async getProfile(@User() user: Admin) {  // Use @User() decorator
  return user;
}
```

**Available Permissions:**
- `super_admin` - Full system access
- `ideas_manager` - Manage ideas and voting
- `events_manager` - Manage events and registrations
- `members_manager` - Manage members and patrons
- `financial_manager` - Manage budgets and expenses

### Frontend Component Patterns

**Standard component structure:**
```typescript
export function MyComponent() {
  // 1. State hooks
  const [localState, setLocalState] = useState();

  // 2. Data fetching hooks (TanStack Query)
  const { data, isLoading } = useQuery(...);

  // 3. Mutation hooks
  const mutation = useMutation({
    mutationFn: async (data) => { ... },
    onSuccess: () => queryClient.invalidateQueries(["/api/resource"])
  });

  // 4. Event handlers
  const handleSubmit = () => mutation.mutate(data);

  // 5. Early returns for loading/error states
  if (isLoading) return <Spinner />;

  // 6. Render
  return <div>...</div>;
}
```

**Data Fetching Pattern:**
```typescript
// Create custom hook in client/src/hooks/
export function useIdeas() {
  return useQuery({
    queryKey: ["/api/ideas"],
    queryFn: async () => {
      const res = await fetch("/api/ideas");
      if (!res.ok) throw new Error("Failed to fetch ideas");
      return res.json();
    }
  });
}

// Use in component
const { data: ideas, isLoading, error } = useIdeas();
```

**Mutation Pattern:**
```typescript
export function useCreateIdea() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (data: InsertIdea) => {
      const res = await fetch("/api/ideas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error("Failed to create idea");
      return res.json();
    },
    onSuccess: () => {
      // Invalidate and refetch
      queryClient.invalidateQueries(["/api/ideas"]);
    }
  });
}
```

### Error Handling

**Backend (NestJS):**
- Throw standard HTTP exceptions: `throw new BadRequestException('message')`
- Use global exception filter (`HttpExceptionFilter`) for consistent error responses
- Log errors with structured logging: `logger.error('message', { context: { ... } })`

**Example:**
```typescript
@Injectable()
export class IdeasService {
  async findOne(id: string) {
    const idea = await this.db.query.ideas.findFirst({
      where: eq(ideas.id, id)
    });

    if (!idea) {
      throw new NotFoundException(`Idea with ID ${id} not found`);
    }

    return idea;
  }
}
```

**Frontend:**
- Use TanStack Query's `isError` state
- Display user-friendly error messages from `error.message`
- Use toast notifications for transient errors
- ErrorBoundary component catches React errors

**Example:**
```typescript
const { data, isLoading, error } = useIdeas();

if (error) {
  return <ErrorAlert message={error.message} />;
}
```

## Project-Specific Conventions

### File Naming

- **Backend:** `kebab-case.ts` for files, `PascalCase` for classes
  - `ideas.service.ts`, `IdeasService`
  - `events.controller.ts`, `EventsController`
- **Frontend:** `PascalCase.tsx` for components, `kebab-case.tsx` for pages
  - `IdeaCard.tsx`, `EventList.tsx`
  - `ideas.tsx`, `admin-dashboard.tsx`
- **Shared:** `kebab-case.ts` for schemas and utilities
  - `schema.ts`, `errors.ts`

### Semantic Colors

**Use semantic classes instead of hardcoded colors:**

Always prefer semantic color classes over Tailwind's raw colors:

❌ **Bad:**
```tsx
<button className="bg-green-500 text-white">Save</button>
<div className="text-red-600">Error message</div>
```

✅ **Good:**
```tsx
<button className="bg-success text-white">Save</button>
<div className="text-error">Error message</div>
```

**Available Semantic Colors:**

**Success (green tones):**
- `bg-success`, `text-success`, `border-success`
- `bg-success-dark`, `text-success-dark`, `border-success-dark`
- `bg-success-light`, `text-success-light`, `border-success-light`

**Warning (orange tones):**
- `bg-warning`, `text-warning`, `border-warning`
- `bg-warning-dark`, `text-warning-dark`, `border-warning-dark`
- `bg-warning-light`, `text-warning-light`, `border-warning-light`

**Error (red tones):**
- `bg-error`, `text-error`, `border-error`
- `bg-error-dark`, `text-error-dark`, `border-error-dark`
- `bg-error-light`, `text-error-light`, `border-error-light`

**Info (blue tones):**
- `bg-info`, `text-info`, `border-info`
- `bg-info-dark`, `text-info-dark`, `border-info-dark`
- `bg-info-light`, `text-info-light`, `border-info-light`

**Primary (brand colors):**
- `bg-primary`, `text-primary`, `border-primary`
- `bg-primary-dark`, `text-primary-dark`, `border-primary-dark`
- `bg-primary-light`, `text-primary-light`, `border-primary-light`

**Rationale:** Semantic colors are configurable via the branding system. Using them ensures consistency and enables theme customization.

### Status Constants

Always use constants from `shared/schema.ts` instead of hardcoded strings:

❌ **Bad:**
```typescript
if (idea.status === "approved") { ... }
if (event.status === "published") { ... }
```

✅ **Good:**
```typescript
import { IDEA_STATUS, EVENT_STATUS } from "@shared/schema";

if (idea.status === IDEA_STATUS.APPROVED) { ... }
if (event.status === EVENT_STATUS.PUBLISHED) { ... }
```

**Available Constants:**
- `IDEA_STATUS` - Idea workflow states
- `EVENT_STATUS` - Event lifecycle states
- `LOAN_STATUS` - Equipment loan states
- `ADMIN_ROLES` - User permission roles
- `ADMIN_STATUS` - User account states

## Testing

### Playwright E2E Tests

**Location:** `tests/e2e/`

**Running tests:**
```bash
# Run all E2E tests
npm run test:playwright

# Run with UI
npm run test:playwright -- --ui

# Run specific test file
npm run test:playwright tests/e2e/ideas.spec.ts

# Debug mode
npm run test:playwright -- --debug
```

**Test Reports:**
- Located in `tests/reports/`
- HTML report: `npm run test:analyze`

### Manual Testing Checklist

When making changes, manually verify:

1. **Ideas CRUD:**
   - Create new idea
   - Vote on ideas
   - Approve/reject ideas (admin)
   - Archive ideas

2. **Events CRUD:**
   - Create event with HelloAsso integration
   - Publish event
   - Register for event
   - Cancel registration

3. **Admin Authentication:**
   - Login via Authentik
   - User sync from Authentik
   - Role-based access control

4. **Member/Patron Management:**
   - Create member
   - Update patron information
   - Search and filter

5. **Loan Items:**
   - Create loan item
   - Borrow item
   - Return item
   - Track status

6. **Financial Dashboard:**
   - View budgets
   - Add expenses
   - Filter by date range

7. **PWA Offline Mode:**
   - Go offline
   - Perform actions (queued)
   - Go online (auto-sync)

## Common Issues and Solutions

### "Module not found" errors

**Symptoms:**
- Import errors in TypeScript
- Cannot find module '@/' or '@shared/'

**Solutions:**
1. Check import aliases are configured in `tsconfig.json`:
   ```json
   {
     "compilerOptions": {
       "paths": {
         "@/*": ["./client/src/*"],
         "@shared/*": ["./shared/*"]
       }
     }
   }
   ```
2. Verify file exists at expected path
3. Restart TypeScript server (Cmd+Shift+P → "TypeScript: Restart TS Server")

### Database connection errors

**Symptoms:**
- "Connection refused" errors
- "Could not connect to database"

**Solutions:**
1. Ensure PostgreSQL container is running:
   ```bash
   docker compose -f docker-compose.services.yml ps
   ```
2. Check `DATABASE_URL` format and credentials in `.env`:
   ```bash
   # Local development
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/cjd80

   # Neon (production)
   DATABASE_URL=postgresql://user:pass@host.neon.tech/database
   ```
3. For Neon: Copy connection string from Neon dashboard
4. Test connection:
   ```bash
   npm run db:connect
   ```

### Authentik authentication fails

**Symptoms:**
- Login redirects to error page
- "Invalid OAuth2 callback" errors
- User not synced to database

**Solutions:**
1. Verify Authentik services are running:
   ```bash
   docker compose -f docker-compose.services.yml logs authentik-server
   ```
2. Check callback URL matches in both `.env` and Authentik provider config:
   - `.env`: `AUTHENTIK_REDIRECT_URI=http://localhost:5000/api/auth/authentik/callback`
   - Authentik UI: Provider → Redirect URIs
3. Ensure application is created in Authentik with correct OAuth2 settings:
   - Application type: OAuth2/OpenID Provider
   - Client type: Confidential
   - Authorization flow: Authorization Code
4. Verify groups exist in Authentik and are mapped to users:
   - Go to Authentik UI → Directory → Groups
   - Ensure groups like "super_admin", "ideas_manager" exist
   - Check user is assigned to appropriate groups
5. Check Authentik token is valid:
   ```bash
   # Test Authentik API
   curl -H "Authorization: Bearer $AUTHENTIK_TOKEN" \
     http://localhost:9002/api/v3/core/groups/
   ```

### Build fails with heap out of memory

**Symptoms:**
- "JavaScript heap out of memory" during build
- Build process crashes

**Solutions:**
1. Use production Dockerfile (optimized):
   ```bash
   docker build -f Dockerfile.production .
   ```
2. Or build locally and deploy:
   ```bash
   ./scripts/build-and-copy-to-vps.sh
   ```
3. Increase Node memory limit:
   ```bash
   NODE_OPTIONS="--max-old-space-size=4096" npm run build
   ```

### Service worker not updating

**Symptoms:**
- Changes not reflected in browser
- Old version of app still loading
- Deploy info shows old timestamp

**Solutions:**
1. Clear browser cache and service worker:
   - Chrome DevTools → Application → Service Workers → Unregister
   - Application → Clear storage → Clear site data
2. Check `deploy-info.json` has new timestamp:
   ```bash
   cat client/public/deploy-info.json
   ```
3. Hard reload browser:
   - Windows/Linux: Ctrl+Shift+R
   - macOS: Cmd+Shift+R
4. If still not updating:
   ```bash
   # Rebuild with new timestamp
   npm run build
   ```

## Best Practices

### NestJS

- **Always use dependency injection** - Constructor-based DI for all dependencies
- **Use DTOs for validation** - Create DTO classes with validation decorators
- **Apply guards consistently** - `@UseGuards(AuthGuard)` on protected routes
- **Log with NestJS Logger** - Avoid `console.log`, use injected `Logger`
- **Handle errors properly** - Throw HTTP exceptions, let global filter handle formatting

### Drizzle ORM

- **Use query builder, not raw SQL** - Leverage Drizzle's type safety
- **Prefer transactions for multi-step operations**
- **Use prepared statements** (done automatically by Drizzle)
- **Leverage schema validation** - Use `createInsertSchema()` for Zod schemas
- **Index frequently queried columns** - Add indexes in schema definition

### React & Frontend

- **Functional components only** - Use hooks, not class components
- **Type all props** - TypeScript strict mode enabled
- **Use TanStack Query for API calls** - Centralize data fetching in hooks
- **Prefer shadcn/ui components** - Consistent UI with Radix primitives
- **Follow semantic color system** - Use `bg-success`, not `bg-green-500`
- **Handle loading and error states** - Always show feedback to users

### Security

- **Never commit secrets** - Use `.env` file, add to `.gitignore`
- **Validate all inputs** - Use Zod schemas on both frontend and backend
- **Protect admin routes** - Apply `@UseGuards(AuthGuard, PermissionGuard)`
- **Sanitize user content** - Escape HTML, prevent XSS
- **Audit sensitive operations** - Log admin actions for accountability

### Performance

- **Avoid N+1 queries** - Use Drizzle's relational queries with `with`
- **Cache expensive queries** - Consider Redis for frequently accessed data
- **Lazy load heavy components** - Use React's `lazy()` and `Suspense`
- **Optimize images** - Use WebP, set width/height, lazy load
- **Use PWA caching** - Service worker caches static assets

## Git Workflow

### Commit Messages

Use conventional commits format in **French**:

```
type: description courte

feat: ajout module gestion événements
fix: correction bug vote sur idées
refactor: migration Express vers NestJS
docs: mise à jour documentation branding
chore: mise à jour dépendances
```

**Types:**
- `feat` - Nouvelle fonctionnalité
- `fix` - Correction de bug
- `refactor` - Refactoring sans changement fonctionnel
- `docs` - Documentation
- `chore` - Tâches diverses (deps, config, etc.)
- `test` - Ajout/modification de tests

### Branch Strategy

- **main** - Production branch (protected)
- **feature/nom-feature** - Feature branches
- **fix/nom-bug** - Bug fix branches

### Pull Requests

1. Create feature branch from `main`
2. Make atomic commits
3. Open PR with description
4. Get code review
5. Merge to `main` after approval

**Never force push to `main`**

## Infrastructure Protection

CJD80 is a **production application** used by the organization.

### Critical Operations Requiring Plan

Before any infrastructure change, **create a detailed plan and get user validation**:

**Infrastructure changes include:**
- Docker Compose modifications
- Database schema changes (especially production)
- Environment variable changes
- Authentik configuration changes
- Nginx/Traefik reverse proxy config
- Systemd services

**Follow workflow in `~/.claude/rules/10-infrastructure.md`**

### Deployment Safety

1. **Test locally first** - Always test changes in local Docker environment
2. **Backup database** - Before schema changes in production
3. **Monitor after deployment** - Check logs, health endpoints
4. **Have rollback plan** - Document how to revert changes

### Authentik Changes

Authentik configuration is critical for authentication.

**Before modifying:**
1. Document current state (providers, applications, groups)
2. Test changes in local Docker Authentik instance
3. Backup Authentik database
4. Have manual login fallback ready

## Documentation

### Keep Documentation Updated

When adding features, update:

1. **README.md** - User-facing documentation
2. **This file (CLAUDE.md)** - Development guidance
3. **docs/** directory - Technical documentation
4. **API comments** - JSDoc comments on public APIs

### Key Documentation Files

- `README.md` - Complete project documentation
- `docs/` - Organized technical documentation
- `docs/deployment/` - Deployment guides
- `docs/features/CUSTOMIZATION.md` - Branding system documentation
- `docs/migration/` - Migration reports (NestJS, Authentik)
- `.cursor/rules/` - Cursor AI rules (100+ files for AI assistance)
