# Features Modulaires - CJD80 "BoÃ®te Ã  Kiffs"

**Version:** 1.0.0
**DerniÃ¨re mise Ã  jour:** 2026-01-15
**Stack:** NestJS 11 + Next.js 16 + PostgreSQL + Drizzle ORM

---

## Architecture Globale

### Backend (NestJS 11)
**Structure modulaire** avec 11 modules features + modules communs

```
server/src/
â”œâ”€â”€ auth/                 # Authentification OAuth2 + Local
â”œâ”€â”€ ideas/                # Gestion idÃ©es collaboratives
â”œâ”€â”€ events/               # Gestion Ã©vÃ©nements + HelloAsso
â”œâ”€â”€ members/              # CRM Membres
â”œâ”€â”€ patrons/              # CRM Parrains/Sponsors
â”œâ”€â”€ loans/                # PrÃªt matÃ©riel
â”œâ”€â”€ financial/            # Budget & DÃ©penses
â”œâ”€â”€ admin/                # Interface administration
â”œâ”€â”€ branding/             # SystÃ¨me branding customizable
â”œâ”€â”€ tracking/             # Suivi activitÃ©s
â”œâ”€â”€ chatbot/              # Interface conversationnelle
â”œâ”€â”€ common/               # Utilitaires partagÃ©s
â”œâ”€â”€ config/               # Configuration
â”œâ”€â”€ health/               # Health checks
â”œâ”€â”€ integrations/         # IntÃ©grations tierces
â””â”€â”€ types/                # Types partagÃ©s
```

### Frontend (Next.js 16 + App Router)
**33 pages** organisÃ©es en route groups

```
app/
â”œâ”€â”€ (admin)/              # Zone admin protÃ©gÃ©e
â”‚   â””â”€â”€ admin/
â”‚       â”œâ”€â”€ dashboard/        # Dashboard principal
â”‚       â”œâ”€â”€ content/          # Gestion contenu (ideas, events, loans)
â”‚       â”œâ”€â”€ crm/              # CRM (members, patrons)
â”‚       â”œâ”€â”€ finance/          # Finance (budgets, expenses, reports)
â”‚       â””â”€â”€ settings/         # ParamÃ¨tres (branding, features, email)
â”œâ”€â”€ (auth)/               # Pages authentification
â”‚   â”œâ”€â”€ auth/                 # Login OAuth2/Local
â”‚   â”œâ”€â”€ forgot-password/      # Mot de passe oubliÃ©
â”‚   â””â”€â”€ reset-password/       # RÃ©initialisation
â””â”€â”€ (public)/             # Pages publiques
    â”œâ”€â”€ events/               # Liste Ã©vÃ©nements
    â”œâ”€â”€ onboarding/           # Onboarding nouveaux users
    â”œâ”€â”€ propose/              # Proposer idÃ©e
    â”œâ”€â”€ loan/                 # Demande prÃªt matÃ©riel
    â””â”€â”€ tools/                # Outils dirigeants
```

---

## ğŸ“‹ Features par Module

### 1. Authentification & Autorisation (auth/)

**Type:** Core Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `auth.module.ts` - Configuration Passport + Session
- `strategies/authentik.strategy.ts` - OAuth2 Authentik
- `guards/auth.guard.ts` - Protection routes
- `guards/permission.guard.ts` - RBAC
- `user-sync.service.ts` - Sync users Authentik â†’ DB

**FonctionnalitÃ©s:**
- ğŸ” OAuth2/OIDC via Authentik (mode par dÃ©faut)
- ğŸ”‘ Login local avec email/password (fallback)
- ğŸ‘¥ Synchronisation automatique users depuis Authentik
- ğŸ·ï¸ Mapping groupes Authentik â†’ RÃ´les application
- ğŸ”’ Session-based authentication (connect-pg-simple)
- âœ‰ï¸ Forgot password + Reset password (mode local)

**RÃ´les disponibles:**
```typescript
ADMIN_ROLES = {
  SUPER_ADMIN: 'super_admin',           // AccÃ¨s total
  IDEAS_MANAGER: 'ideas_manager',       // Gestion idÃ©es
  EVENTS_MANAGER: 'events_manager',     // Gestion Ã©vÃ©nements
  MEMBERS_MANAGER: 'members_manager',   // Gestion membres
  FINANCE_MANAGER: 'finance_manager'    // Gestion finances
}
```

**Configuration requise:**
```env
AUTHENTIK_BASE_URL=http://localhost:9002
AUTHENTIK_CLIENT_ID=...
AUTHENTIK_CLIENT_SECRET=...
AUTHENTIK_ISSUER=...
AUTHENTIK_REDIRECT_URI=...
SESSION_SECRET=...
```

**Endpoints API:**
- `GET /api/auth/user` - User courant
- `GET /api/auth/mode` - Mode auth (oauth|local)
- `GET /api/auth/authentik` - DÃ©marrer flow OAuth2
- `GET /api/auth/authentik/callback` - Callback OAuth2
- `POST /api/auth/login` - Login local
- `POST /api/auth/logout` - DÃ©connexion
- `POST /api/auth/forgot-password` - Demande reset
- `POST /api/auth/reset-password` - Appliquer reset

---

### 2. IdÃ©es Collaboratives (ideas/)

**Type:** Feature Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `ideas.module.ts`
- `ideas.controller.ts`
- `ideas.service.ts`

**FonctionnalitÃ©s:**
- ğŸ’¡ Proposition d'idÃ©es (formulaire public)
- ğŸ‘ SystÃ¨me de votes (+1/-1)
- ğŸ“Š Statistiques votes par idÃ©e
- ğŸ”„ Workflow de validation (pending â†’ approved/rejected â†’ in_progress â†’ completed)
- ğŸ·ï¸ CatÃ©gorisation idÃ©es
- ğŸ“ Commentaires et discussions
- ğŸ“ˆ Ranking par score de votes

**Statuts idÃ©es:**
```typescript
IDEA_STATUS = {
  PENDING: 'pending',           // En attente validation
  APPROVED: 'approved',         // ApprouvÃ©e
  REJECTED: 'rejected',         // RejetÃ©e
  IN_PROGRESS: 'in_progress',   // En cours de rÃ©alisation
  COMPLETED: 'completed'        // RÃ©alisÃ©e
}
```

**Endpoints API:**
- `GET /api/ideas` - Liste idÃ©es (filtrables par status)
- `GET /api/ideas/:id` - DÃ©tail idÃ©e
- `POST /api/ideas` - CrÃ©er idÃ©e
- `PUT /api/ideas/:id` - Modifier idÃ©e (admin)
- `DELETE /api/ideas/:id` - Supprimer idÃ©e (admin)
- `POST /api/ideas/:id/vote` - Voter (+1/-1)
- `GET /api/ideas/:id/votes` - Stats votes

**Frontend:**
- Page publique: `/propose` (formulaire proposition)
- Admin: `/admin/content/ideas` (gestion + validation)

---

### 3. Ã‰vÃ©nements (events/)

**Type:** Feature Module
**Statut:** âœ… Production
**IntÃ©grations:** HelloAsso API
**Fichiers clÃ©s:**
- `events.module.ts`
- `events.controller.ts`
- `events.service.ts`

**FonctionnalitÃ©s:**
- ğŸ“… CRUD Ã©vÃ©nements (titre, description, date, lieu, image)
- ğŸ« IntÃ©gration HelloAsso pour billetterie
- ğŸ“‹ Gestion inscriptions
- ğŸ”— Redirection externe optionnelle
- ğŸ“Š Statistiques participation
- ğŸ“¸ Upload images Ã©vÃ©nements (MinIO)
- ğŸ”” Notifications push (PWA)

**Statuts Ã©vÃ©nements:**
```typescript
EVENT_STATUS = {
  DRAFT: 'draft',           // Brouillon (invisible public)
  PUBLISHED: 'published',   // PubliÃ© (visible)
  CANCELLED: 'cancelled',   // AnnulÃ©
  COMPLETED: 'completed'    // TerminÃ©
}
```

**Endpoints API:**
- `GET /api/events` - Liste Ã©vÃ©nements publics (published)
- `GET /api/admin/events` - Liste tous Ã©vÃ©nements (admin)
- `GET /api/events/:id` - DÃ©tail Ã©vÃ©nement
- `POST /api/events` - CrÃ©er Ã©vÃ©nement (admin)
- `PUT /api/events/:id` - Modifier Ã©vÃ©nement (admin)
- `DELETE /api/events/:id` - Supprimer Ã©vÃ©nement (admin)
- `POST /api/events/:id/register` - S'inscrire
- `GET /api/events/:id/registrations` - Liste inscrits (admin)

**Frontend:**
- Page publique: `/events` (liste + dÃ©tails)
- Admin: `/admin/content/events` (gestion complÃ¨te)

---

### 4. CRM Membres (members/)

**Type:** Feature Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `members.module.ts`
- `members.controller.ts`
- `members.service.ts`

**FonctionnalitÃ©s:**
- ğŸ‘¤ Fiche membre (nom, prÃ©nom, entreprise, fonction, contact)
- ğŸ“§ Emails membres
- ğŸ“± TÃ©lÃ©phones
- ğŸ¢ Entreprise et fonction
- ğŸ—“ï¸ Date adhÃ©sion
- ğŸ·ï¸ Tags/catÃ©gories
- ğŸ“ Notes internes
- ğŸ“Š Historique activitÃ©s
- ğŸ“¤ Export CSV

**Endpoints API:**
- `GET /api/members` - Liste membres
- `GET /api/members/:id` - DÃ©tail membre
- `POST /api/members` - CrÃ©er membre (admin)
- `PUT /api/members/:id` - Modifier membre (admin)
- `DELETE /api/members/:id` - Supprimer membre (admin)
- `GET /api/members/export` - Export CSV (admin)

**Frontend:**
- Admin: `/admin/crm/members` (gestion complÃ¨te)

---

### 5. CRM Parrains/Sponsors (patrons/)

**Type:** Feature Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `patrons.module.ts`
- `patrons.controller.ts`
- `patrons.service.ts`

**FonctionnalitÃ©s:**
- ğŸ¢ Fiche parrain/sponsor
- ğŸ’° Montant sponsoring
- ğŸ“… Date dÃ©but/fin partenariat
- ğŸ”— Logo + URL entreprise
- ğŸ“ Description partenariat
- ğŸ“Š Historique financier
- ğŸ“¤ Export CSV

**Endpoints API:**
- `GET /api/patrons` - Liste parrains
- `GET /api/patrons/:id` - DÃ©tail parrain
- `POST /api/patrons` - CrÃ©er parrain (admin)
- `PUT /api/patrons/:id` - Modifier parrain (admin)
- `DELETE /api/patrons/:id` - Supprimer parrain (admin)

**Frontend:**
- Admin: `/admin/crm/patrons` (gestion complÃ¨te)

---

### 6. PrÃªt MatÃ©riel (loans/)

**Type:** Feature Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `loans.module.ts`
- `loans.controller.ts`
- `loans.service.ts`

**FonctionnalitÃ©s:**
- ğŸ’ Inventaire matÃ©riel prÃªtable
- ğŸ“‹ Demandes de prÃªt (formulaire public)
- âœ… Validation demandes (admin)
- ğŸ“… Suivi dates prÃªt/retour
- ğŸ”„ Workflow emprunt (available â†’ borrowed â†’ returned)
- ğŸš¨ Signalement dÃ©gÃ¢ts
- ğŸ“Š Historique emprunts

**Statuts matÃ©riel:**
```typescript
LOAN_STATUS = {
  AVAILABLE: 'available',   // Disponible
  BORROWED: 'borrowed',     // EmpruntÃ©
  RETURNED: 'returned',     // RetournÃ©
  DAMAGED: 'damaged'        // EndommagÃ© (maintenance)
}
```

**Endpoints API:**
- `GET /api/loans` - Liste matÃ©riel disponible
- `GET /api/loans/:id` - DÃ©tail matÃ©riel
- `POST /api/loans/request` - Demander prÃªt (public)
- `GET /api/admin/loans` - Toutes demandes (admin)
- `PUT /api/admin/loans/:id/approve` - Approuver (admin)
- `PUT /api/admin/loans/:id/return` - Marquer retournÃ© (admin)

**Frontend:**
- Page publique: `/loan` (formulaire demande)
- Admin: `/admin/content/loans` (gestion)

---

### 7. Finance (financial/)

**Type:** Feature Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `financial.module.ts`
- `financial.controller.ts`
- `financial.service.ts`

**FonctionnalitÃ©s:**
- ğŸ’° Budgets annuels/mensuels
- ğŸ“ Suivi dÃ©penses
- ğŸ“Š Rapports financiers
- ğŸ“ˆ PrÃ©visions
- ğŸ¢ Parrainages/sponsorings
- ğŸ“‰ Graphiques budget vs rÃ©el
- ğŸ” CatÃ©gories dÃ©penses
- ğŸ“¤ Export comptable

**Endpoints API:**
- `GET /api/finance/budgets` - Liste budgets
- `POST /api/finance/budgets` - CrÃ©er budget (admin)
- `GET /api/finance/expenses` - Liste dÃ©penses
- `POST /api/finance/expenses` - Ajouter dÃ©pense (admin)
- `GET /api/finance/dashboard` - Stats dashboard
- `GET /api/finance/reports` - Rapports (admin)
- `GET /api/finance/forecasts` - PrÃ©visions (admin)

**Frontend:**
- Admin: `/admin/finance/*` (6 pages: dashboard, budgets, expenses, forecasts, reports, sponsorships)

---

### 8. Administration (admin/)

**Type:** Core Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `admin.module.ts`
- `admin.controller.ts`
- `admin.service.ts`

**FonctionnalitÃ©s:**
- ğŸ‘¥ Gestion admins (CRUD)
- ğŸ” Attribution rÃ´les/permissions
- ğŸ“Š Dashboard statistiques
- ğŸ“§ Configuration email
- âš™ï¸ ParamÃ¨tres application
- ğŸ¨ Customisation branding
- ğŸ§© Activation/dÃ©sactivation features
- ğŸ“‹ Logs audit

**Endpoints API:**
- `GET /api/admin/dashboard` - Stats dashboard
- `GET /api/admin/users` - Liste admins
- `POST /api/admin/users` - CrÃ©er admin
- `PUT /api/admin/users/:id` - Modifier admin
- `DELETE /api/admin/users/:id` - Supprimer admin

**Frontend:**
- Admin: `/admin/*` (dashboard + sous-sections)

---

### 9. Branding Customizable (branding/)

**Type:** Feature Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `branding.module.ts`
- `branding.controller.ts`
- `branding.service.ts`

**FonctionnalitÃ©s:**
- ğŸ¨ 17 couleurs configurables (success, warning, error, info + variants)
- ğŸ–¼ï¸ Upload logo personnalisÃ© (MinIO)
- ğŸ·ï¸ Nom organisation + app
- ğŸŒ URLs et contacts
- ğŸ“± Configuration PWA (theme color, icons)
- ğŸ’¾ Sauvegarde config en DB (JSON)
- ğŸ”„ Switch default â†” custom en temps rÃ©el
- ğŸ­ Semantic color system (CSS variables)

**Couleurs configurables:**
```typescript
colors = {
  // Marque
  primary, primaryDark, primaryLight,
  secondary, background,

  // Ã‰tats
  success, successDark, successLight,
  warning, warningDark, warningLight,
  error, errorDark, errorLight,
  info, infoDark, infoLight,

  // Charts
  chart1, chart2, chart3, chart4, chart5
}
```

**Endpoints API:**
- `GET /api/admin/branding` - Config branding actuelle
- `PUT /api/admin/branding` - Sauvegarder config (admin)
- `POST /api/admin/branding/logo` - Upload logo (admin)
- `POST /api/admin/branding/reset` - Reset to defaults (admin)

**Frontend:**
- Admin: `/admin/settings/branding` (interface complÃ¨te)
- Context: `BrandingContext` (provider global)
- Helper: `client/src/lib/branding.ts`

**Configuration:**
- Core: `client/src/config/branding-core.ts` (pure config, sans assets)
- Assets: `client/src/config/branding.ts` (avec assets bundlÃ©s)

---

### 10. Tracking ActivitÃ©s (tracking/)

**Type:** Feature Module
**Statut:** âœ… Production
**Fichiers clÃ©s:**
- `tracking.module.ts`
- `tracking.controller.ts`
- `tracking.service.ts`

**FonctionnalitÃ©s:**
- ğŸ“ˆ Suivi activitÃ©s utilisateurs
- ğŸ• Timestamps actions
- ğŸ” Filtres par type/user/date
- ğŸ“Š Rapports activitÃ©
- ğŸ—„ï¸ Archivage automatique

**Endpoints API:**
- `GET /api/tracking` - Liste activitÃ©s (admin)
- `POST /api/tracking` - Logger activitÃ©
- `GET /api/tracking/stats` - Statistiques (admin)

**Frontend:**
- Admin: `/admin/tracking` (vue liste + stats)

---

### 11. Chatbot (chatbot/)

**Type:** Feature Module (ExpÃ©rimental)
**Statut:** ğŸš§ En dÃ©veloppement
**Fichiers clÃ©s:**
- `chatbot.module.ts`
- `chatbot.controller.ts`
- `chatbot.service.ts`

**FonctionnalitÃ©s:**
- ğŸ’¬ Interface conversationnelle
- ğŸ¤– IntÃ©gration IA (Claude/GPT)
- ğŸ“‹ Commandes rapides
- ğŸ” Recherche intelligente

**Note:** Feature en cours de dÃ©veloppement, pas encore exposÃ©e en production.

---

## ğŸ”§ Modules Communs & Utilitaires

### common/
**Contenu:**
- `database/` - Providers Drizzle DB
- `guards/` - Guards partagÃ©s
- `interceptors/` - Logging, DB monitoring
- `filters/` - Exception handling global
- `decorators/` - Custom decorators (@User, @Permissions)
- `middlewares/` - Middlewares Express/NestJS

### config/
**Contenu:**
- Configuration environnement
- Validation env vars
- Constants globales

### integrations/
**IntÃ©grations tierces:**
- `authentik/` - Client API Authentik
- `helloasso/` - Client API HelloAsso
- `minio/` - Client S3 MinIO

---

## ğŸŒ Progressive Web App (PWA)

**Statut:** âœ… Production (implÃ©mentation manuelle)
**Fichiers clÃ©s:**
- `client/public/sw.js` - Service Worker (528 lignes)
- `client/public/sw-register.js` - Registration
- `client/public/manifest.json` - PWA manifest

**FonctionnalitÃ©s:**
- ğŸ“± Installable (Add to Home Screen)
- ğŸ“´ Mode offline avec queue
- ğŸ”„ Background sync
- ğŸ”” Push notifications
- ğŸ’¾ Cache intelligente (cache-first pour assets, network-first pour API)
- ğŸ” Auto-sync toutes les heures

**Files cached:**
- `/` - Page d'accueil
- `/manifest.json`
- Assets statiques (CSS, JS, fonts, images)

**Offline queue:**
- Actions saved to IndexedDB
- Auto-sync when online
- Banner shows offline status

---

## ğŸ¨ SystÃ¨me UI & Design

### shadcn/ui Components
**InstallÃ©s:**
- Button, Input, Textarea, Label
- Dialog, Sheet, Popover, Dropdown
- Card, Badge, Avatar
- Table, Pagination
- Toast, Alert
- Tooltip, Tabs
- Form (React Hook Form + Zod)
- Select, Checkbox, Radio
- Calendar, DatePicker

### Tailwind CSS
- **JIT mode** enabled
- **Semantic colors:** bg-success, text-error, border-warning, etc.
- **Dark mode:** via next-themes
- **Custom utilities:** line-clamp-2, line-clamp-3, break-words

### Fonts
- **Primary:** Lato (300, 400, 700, 900)
- **Import:** Google Fonts via `index.css`

---

## ğŸ“Š Base de DonnÃ©es (PostgreSQL + Drizzle)

### Tables principales

```typescript
// Authentification
admins                  // Users/admins
sessions                // Express sessions

// Contenu
ideas                   // IdÃ©es collaboratives
votes                   // Votes sur idÃ©es
events                  // Ã‰vÃ©nements
inscriptions            // Inscriptions Ã©vÃ©nements

// CRM
members                 // Membres CJD
patrons                 // Parrains/sponsors

// MatÃ©riel
loan_items              // MatÃ©riel prÃªtable
loan_requests           // Demandes prÃªt (historique)

// Finance
budgets                 // Budgets
expenses                // DÃ©penses

// SystÃ¨me
tracking_items          // ActivitÃ©s
branding_config         // Config branding (1 ligne, JSON)
feature_config          // Feature flags (1 ligne, JSON)
```

### SchÃ©ma & Validation
**Fichier:** `shared/schema.ts`
- Drizzle tables definitions
- Zod schemas (via `createInsertSchema`)
- TypeScript types infÃ©rÃ©s
- Status constants

**Commands:**
```bash
npm run db:push       # Sync schema to DB
npm run db:connect    # psql connection
npm run db:monitor    # Connection monitoring
```

---

## ğŸ§ª Testing

### Playwright E2E
**Tests:**
- `tests/e2e/admin.spec.ts` - Tests admin flow
- `tests/e2e/onboarding.spec.ts` - Tests onboarding

**Commands:**
```bash
npm run test:playwright     # Run all tests
npm run test:analyze        # Analyze results
```

---

## ğŸš€ DÃ©ploiement

### Build Production
```bash
npm run build               # Next.js + TypeScript backend
npm start                   # Start production server
```

### Docker Services (Dev)
```bash
docker compose -f docker-compose.services.yml up -d
# Services: PostgreSQL, Redis, Authentik server/worker
```

### Environment Variables
**Required:**
- `DATABASE_URL` - PostgreSQL connection
- `SESSION_SECRET` - Session encryption
- `AUTHENTIK_*` - OAuth2 config (6 vars)
- `MINIO_*` - Object storage (4 vars)

---

## ğŸ“ ProblÃ¨mes Connus

### 1. TypeScript Backend (8 erreurs)
**Status:** âš ï¸ PrÃ©-existants (backend fonctionnel en dev)
**Fichiers:** `server/src/auth/adapters/*.ts`
**Erreur:** Drizzle ORM type mismatch sur `.update().set()`
**Impact:** Build backend Ã©choue, mais dev mode fonctionne (tsx)
**Fix:** Typer correctement les objets passÃ©s Ã  `.set()`

### 2. SSR Build Warnings (location is not defined)
**Status:** âš ï¸ Warnings pendant `next build`
**Erreur:** `ReferenceError: location is not defined` dans chunks SSR
**Impact:** Build rÃ©ussit, 34 routes gÃ©nÃ©rÃ©es, warnings ignorables
**Cause probable:** Composant utilise `location` sans vÃ©rifier `typeof window`
**Fix:** Identifier composant + wrapper avec `typeof window !== 'undefined'`

---

## ğŸ“š Documentation

**Fichiers clÃ©s:**
- `CLAUDE.md` - Guide complet projet (552 lignes)
- `.claude-stack.md` - Stack technique (351 lignes)
- `.claude-rules.md` - RÃ¨gles engagement IA (610 lignes)
- `.claude-features.md` - Ce fichier
- `README.md` - Documentation utilisateur
- `MIGRATION-NEXTJS-COMPLETED.md` - Rapport migration Next.js
- `BACKEND-TYPESCRIPT-ISSUES.md` - ProblÃ¨mes TS backend

---

## ğŸ”— Liens Utiles

**Codebase:**
- Repository: `/srv/workspace/cjd80`
- Server: `server/src/`
- Client: `client/src/` + `app/`
- Shared: `shared/`

**URLs Dev:**
- App: https://cjd80.robinswood.io
- Authentik: http://localhost:9002

**Commandes frÃ©quentes:**
```bash
npm run start:dev         # Full dev env
npm run dev:client        # Next.js Turbopack (port 5174)
npm run dev               # NestJS backend (port 5000)
npm run build             # Production build
npm run validate          # Health check
```

---

**DerniÃ¨re mise Ã  jour:** 2026-01-15
**Auteur:** Documentation automatique via analyse codebase
