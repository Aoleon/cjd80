# Guide de Test - Syst√®me de Nettoyage Automatique

## üìã Vue d'ensemble

Ce projet utilise un syst√®me de nettoyage automatique des donn√©es de test pour maintenir une base de donn√©es propre et √©viter l'accumulation de donn√©es de test entre les ex√©cutions de Playwright.

### Fonctionnalit√©s principales

‚úÖ **Nettoyage automatique** : Toutes les donn√©es de test sont supprim√©es apr√®s chaque test  
‚úÖ **Patterns reconnaissables** : Les donn√©es de test utilisent des patterns identifiables (`@test.com`, `[TEST]`)  
‚úÖ **Helpers de g√©n√©ration** : Fonctions utilitaires pour cr√©er des donn√©es de test coh√©rentes  
‚úÖ **Configuration centralis√©e** : Une seule configuration pour g√©rer tous les patterns  

## üöÄ Quick Start

### 1. Importer les fixtures personnalis√©es

**Important** : Toujours importer `test` et `expect` depuis `../fixtures` au lieu de `@playwright/test` :

```typescript
// ‚úÖ CORRECT
import { test, expect } from '../fixtures';

// ‚ùå INCORRECT
import { test, expect } from '@playwright/test';
```

### 2. Utiliser les helpers de g√©n√©ration de donn√©es

```typescript
import { test, expect } from '../fixtures';
import { generateTestIdea, generateTestEmail } from '../helpers/test-data';

test('should create an idea', async ({ page }) => {
  // G√©n√©rer des donn√©es de test reconnaissables
  const testIdea = generateTestIdea({
    title: 'Mon id√©e de test',
    description: 'Description de test'
  });
  
  // Cr√©er l'id√©e via API
  await page.request.post('/api/ideas', {
    data: {
      title: testIdea.title,
      description: testIdea.description,
      proposedBy: testIdea.proposedBy,
      proposedByEmail: testIdea.proposedByEmail,
    }
  });
  
  // Vos assertions ici...
  
  // ‚úÖ Le nettoyage se fait automatiquement apr√®s le test !
});
```

### 3. Ex√©cuter les tests

```bash
# Ex√©cuter tous les tests
npx playwright test

# Ex√©cuter un test sp√©cifique
npx playwright test test-cleanup-demo

# Mode debug
npx playwright test --debug

# Voir les logs de nettoyage
npx playwright test --headed
```

## üì¶ Helpers de G√©n√©ration de Donn√©es

Le fichier `test/helpers/test-data.ts` fournit des fonctions pour g√©n√©rer des donn√©es de test :

### Fonctions de base

```typescript
import {
  generateTestEmail,      // G√©n√®re un email @test.com
  generateTestName,       // G√©n√®re un nom avec [TEST]
  generateTestTitle,      // G√©n√®re un titre avec [TEST]
  generateTestCompany,    // G√©n√®re un nom d'entreprise
  generateTestPhone,      // G√©n√®re un num√©ro de t√©l√©phone
} from '../helpers/test-data';

// Exemples
const email = generateTestEmail();              // test-abc123@test.com
const name = generateTestName('Jean');          // [TEST] Jean xyz789
const title = generateTestTitle('Id√©e');        // [TEST] Id√©e abc456
const company = generateTestCompany();          // Test Company def789
const phone = generateTestPhone();              // +33 6 12 34 56 78
```

### Fonctions compos√©es

```typescript
import {
  generateTestIdea,
  generateTestEvent,
  generateTestVote,
  generateTestInscription,
  generateTestPatron,
  generateTestMember,
} from '../helpers/test-data';

// Id√©e compl√®te
const idea = generateTestIdea({
  title: 'Am√©liorer le site',
  description: 'Description personnalis√©e',
  proposerName: 'Jean Dupont'
});

// √âv√©nement
const event = generateTestEvent({
  title: '√âv√©nement de test',
  daysFromNow: 30,
  location: 'Amiens'
});

// Vote
const vote = generateTestVote({
  voterName: 'Marie Martin'
});

// Inscription
const inscription = generateTestInscription({
  name: 'Pierre Durant',
  includePhone: true,
  comments: 'Commentaire optionnel'
});

// M√©c√®ne
const patron = generateTestPatron({
  firstName: 'Sophie',
  lastName: 'Bernard',
  company: 'TechCorp',
  role: 'CEO',
  includePhone: true
});

// Membre
const member = generateTestMember({
  firstName: 'Lucas',
  lastName: 'Petit',
  company: 'StartupCo'
});
```

### G√©n√©rer des tableaux de donn√©es

```typescript
import { generateTestArray, generateTestVote } from '../helpers/test-data';

// Cr√©er 5 votes de test
const votes = generateTestArray(generateTestVote, 5);

// Cr√©er 10 id√©es de test
const ideas = generateTestArray(() => generateTestIdea(), 10);
```

## üßπ Comment fonctionne le nettoyage ?

### Patterns reconnus

Le syst√®me nettoie automatiquement toutes les donn√©es qui correspondent √† ces patterns :

| Pattern | Exemple | Tables affect√©es |
|---------|---------|-----------------|
| Email `@test.com` | `test-abc@test.com` | Toutes avec email |
| Email `@playwright.test` | `user@playwright.test` | Toutes avec email |
| Pr√©fixe `[TEST]` | `[TEST] Mon id√©e` | ideas, events, etc. |
| Pr√©fixe `[playwright-test]` | `[playwright-test] Item` | Toutes avec titre/nom |
| Company "Test Company" | `Test Company XYZ` | patrons, members |

### Tables nettoy√©es

Le nettoyage s'applique √† toutes les tables principales :

- ‚úÖ `ideas` (id√©es)
- ‚úÖ `votes` (votes)
- ‚úÖ `events` (√©v√©nements)
- ‚úÖ `inscriptions` (inscriptions)
- ‚úÖ `patrons` (m√©c√®nes)
- ‚úÖ `members` (membres)
- ‚úÖ `subscriptions` (abonnements)
- ‚úÖ `activities` (activit√©s)

### Quand le nettoyage s'ex√©cute ?

Le nettoyage se fait **automatiquement apr√®s chaque test** gr√¢ce √† la fixture `autoCleanup` :

```typescript
// Dans test/fixtures.ts
const test = base.extend<{ autoCleanup: void }>({
  autoCleanup: [async ({}, use) => {
    await use();
    // ‚¨áÔ∏è Le nettoyage s'ex√©cute ici apr√®s chaque test
    await cleanupTestData();
  }, { auto: true }]
});
```

## üìù Exemples d'Utilisation

### Exemple 1 : Test d'une id√©e

```typescript
import { test, expect } from '../fixtures';
import { generateTestIdea } from '../helpers/test-data';

test.describe('Ideas', () => {
  test('should create and display an idea', async ({ page }) => {
    const testIdea = generateTestIdea();
    
    // Cr√©er via API
    const response = await page.request.post('/api/ideas', {
      data: {
        title: testIdea.title,
        description: testIdea.description,
        proposedBy: testIdea.proposedBy,
        proposedByEmail: testIdea.proposedByEmail,
      }
    });
    
    expect(response.ok()).toBeTruthy();
    
    // V√©rifier que l'id√©e existe
    await page.goto('/');
    await expect(page.locator(`text=${testIdea.title}`)).toBeVisible();
    
    // ‚úÖ Nettoyage automatique apr√®s ce test
  });
});
```

### Exemple 2 : Test avec plusieurs entit√©s

```typescript
import { test, expect } from '../fixtures';
import { generateTestIdea, generateTestVote } from '../helpers/test-data';

test('should create idea and vote', async ({ page }) => {
  // Cr√©er une id√©e
  const testIdea = generateTestIdea();
  const ideaResponse = await page.request.post('/api/ideas', {
    data: {
      title: testIdea.title,
      description: testIdea.description,
      proposedBy: testIdea.proposedBy,
      proposedByEmail: testIdea.proposedByEmail,
    }
  });
  const idea = await ideaResponse.json();
  
  // Cr√©er un vote
  const testVote = generateTestVote();
  await page.request.post('/api/votes', {
    data: {
      ideaId: idea.id,
      voterName: testVote.voterName,
      voterEmail: testVote.voterEmail,
    }
  });
  
  // V√©rifier
  const getResponse = await page.request.get(`/api/ideas/${idea.id}`);
  const updatedIdea = await getResponse.json();
  expect(updatedIdea.voteCount).toBe(1);
  
  // ‚úÖ L'id√©e ET le vote seront nettoy√©s automatiquement
});
```

### Exemple 3 : Test UI avec formulaire

```typescript
import { test, expect } from '../fixtures';
import { generateTestEmail, generateTestTitle } from '../helpers/test-data';

test('should submit idea form', async ({ page }) => {
  await page.goto('/');
  
  // Utiliser les helpers pour remplir le formulaire
  const title = generateTestTitle('Mon id√©e');
  const email = generateTestEmail('proposeur');
  
  await page.fill('[data-testid="input-idea-title"]', title);
  await page.fill('[data-testid="input-proposer-email"]', email);
  await page.click('[data-testid="button-submit-idea"]');
  
  // V√©rifier la soumission
  await expect(page.locator(`text=${title}`)).toBeVisible();
  
  // ‚úÖ L'id√©e sera nettoy√©e automatiquement
});
```

## üîß Configuration

### Ajouter de nouveaux patterns

Pour ajouter de nouveaux patterns de nettoyage, modifier `test/helpers/cleanup.ts` :

```typescript
// Ajouter un nouveau pattern
const TEST_EMAIL_PATTERNS = [
  '@test.com',
  '@playwright.test',
  '@mynewtestdomain.com',  // ‚¨ÖÔ∏è Nouveau pattern
];

const TEST_PREFIX_PATTERNS = [
  '[TEST]',
  '[playwright-test]',
  '[DEMO]',  // ‚¨ÖÔ∏è Nouveau pattern
];
```

### Ajouter une nouvelle table √† nettoyer

```typescript
// Dans test/helpers/cleanup.ts
export async function cleanupTestData() {
  // ... code existant ...
  
  // Ajouter une nouvelle table
  const myNewTableDeleted = await db
    .delete(myNewTable)
    .where(
      or(
        like(myNewTable.email, '%@test.com'),
        like(myNewTable.title, '[TEST]%')
      )
    );
  
  totalDeleted += myNewTableDeleted.length;
}
```

## üêõ Troubleshooting

### Les donn√©es ne sont pas nettoy√©es

**Probl√®me** : Les donn√©es de test restent dans la base apr√®s les tests.

**Solutions** :
1. V√©rifier que vous importez depuis `../fixtures` et non `@playwright/test`
2. V√©rifier que vos donn√©es utilisent les patterns reconnus (`@test.com`, `[TEST]`)
3. V√©rifier les logs de console pour les erreurs de nettoyage

### Patterns non reconnus

**Probl√®me** : Vos donn√©es de test ne correspondent pas aux patterns.

**Solutions** :
1. Utiliser les helpers de g√©n√©ration (`generateTestEmail`, etc.)
2. Ajouter de nouveaux patterns dans `test/helpers/cleanup.ts`
3. V√©rifier que les emails se terminent par `@test.com` ou `@playwright.test`

### Erreurs de base de donn√©es

**Probl√®me** : Erreurs lors du nettoyage (contraintes de cl√©s √©trang√®res, etc.).

**Solutions** :
1. V√©rifier l'ordre de suppression dans `cleanup.ts` (enfants avant parents)
2. Utiliser des transactions si n√©cessaire
3. Ajouter des logs pour identifier la table probl√©matique

### ‚ö†Ô∏è Rate Limiting de l'API

**Probl√®me** : Les tests √©chouent avec des erreurs 429 ou des cr√©ations qui ne fonctionnent pas.

**Cause** : L'API limite les cr√©ations √† **20 par tranche de 15 minutes** pour pr√©venir les abus.

**Solutions** :
1. **Attendre 15 minutes** entre les ex√©cutions massives de tests
2. **R√©duire le nombre de cr√©ations** dans vos tests (utiliser 2-3 items au lieu de 5-10)
3. **Ajouter des d√©lais** entre les cr√©ations :
   ```typescript
   // Attendre 500ms entre chaque cr√©ation
   await page.waitForTimeout(500);
   ```
4. **Ex√©cuter moins de tests** √† la fois :
   ```bash
   # Au lieu de tous les tests
   npx playwright test test/e2e/test-cleanup-demo.spec.ts
   
   # Ex√©cuter un seul test
   npx playwright test -g "should create and auto-cleanup test idea"
   ```

**Note** : Le syst√®me de nettoyage fonctionne parfaitement. Les √©checs de tests sont uniquement dus au rate limiting, pas au syst√®me de nettoyage.

## üìö Ressources

- **Tests de d√©monstration** : `test/e2e/test-cleanup-demo.spec.ts`
- **Utilitaire de nettoyage** : `test/helpers/cleanup.ts`
- **Fixtures personnalis√©es** : `test/fixtures.ts`
- **Helpers de donn√©es** : `test/helpers/test-data.ts`
- **Configuration Playwright** : `playwright.config.ts`

## üéØ Bonnes Pratiques

### ‚úÖ √Ä FAIRE

- Toujours importer depuis `../fixtures`
- Utiliser les helpers de g√©n√©ration de donn√©es
- Cr√©er des donn√©es de test reconnaissables
- V√©rifier que le nettoyage fonctionne (consulter les logs)
- Ajouter de nouveaux helpers si besoin

### ‚ùå √Ä √âVITER

- Importer depuis `@playwright/test` directement
- Cr√©er des donn√©es sans patterns reconnaissables
- Utiliser des emails r√©els dans les tests
- Laisser des donn√©es manuellement sans nettoyage
- Nettoyer manuellement avec `afterEach` (c'est automatique)

## üîç V√©rifier le Nettoyage

Pour v√©rifier que le nettoyage fonctionne correctement :

1. **Ex√©cuter le test de d√©monstration** :
   ```bash
   npx playwright test test-cleanup-demo
   ```

2. **V√©rifier les logs** :
   ```
   [Cleanup] üßπ D√©but du nettoyage des donn√©es de test...
   [Cleanup] üìä Ideas: 3 enregistrement(s) supprim√©(s)
   [Cleanup] üìä Votes: 2 enregistrement(s) supprim√©(s)
   [Cleanup] ‚úÖ Nettoyage termin√© : 5 enregistrement(s) au total
   ```

3. **V√©rifier la base de donn√©es** :
   ```sql
   -- Aucune donn√©e de test ne devrait rester
   SELECT * FROM ideas WHERE title LIKE '[TEST]%';
   SELECT * FROM votes WHERE voter_email LIKE '%@test.com';
   ```

## üöÄ Prochaines √âtapes

Pour am√©liorer le syst√®me de test :

1. Ajouter plus de helpers pour d'autres entit√©s
2. Cr√©er des sc√©narios de test complexes
3. Ajouter des fixtures pour l'authentification
4. Impl√©menter des snapshots pour les tests visuels
5. Automatiser les tests dans la CI/CD

---

**Questions ou probl√®mes ?** Consultez les tests de d√©monstration ou ouvrez une issue sur le repo.
