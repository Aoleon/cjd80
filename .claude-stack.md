# Stack Technique - CJD80

## Vue d'Ensemble

**CJD Amiens - "Bo√Æte √† Kiffs"** est une application web interne moderne pour le Centre des Jeunes Dirigeants (CJD) d'Amiens permettant la gestion collaborative d'id√©es innovantes, l'organisation d'√©v√©nements avec int√©gration HelloAsso, et une interface d'administration compl√®te.

**Statut Stack:** Transition en cours
- Frontend: React 19 + Next.js 15 (moderne, performant)
- Backend: NestJS 11 (migr√© depuis Express.js en janvier 2025)
- Architecture: Full TypeScript avec Drizzle ORM

---

## Frontend

### Framework & Build

- **React:** 19.0.0 (derni√®re version stable)
- **TypeScript:** 5.6.3 (strict mode)
- **Build Tool:** Next.js 15.1.4 (SSR-capable)
  - **Note d'exception:** Projet utilise Next.js au lieu de Vite pour b√©n√©ficier de :
    - Server-side rendering (pages dynamiques)
    - API routes int√©gr√©es (pr√©f√©r√© NestJS backend)
    - Image optimization natif
    - File-based routing
- **Package Manager:** npm
- **Development:** `npm run dev:next` (Next.js on :3000) + `npm run dev:nest` (NestJS backend on :5000)

### State Management

- **Server State:** TanStack Query (React Query v5)
  - Cache automatique avec staleTime
  - Invalidation intelligente via `queryClient.invalidateQueries()`
  - Optimistic updates
  - Background refetching
- **Local State:** React hooks (useState, useReducer)
- **Form State:** React Hook Form v7.55.0
  - Validation via Zod schemas
  - Int√©gration avec TanStack Query

### Routing

- **Router:** Next.js file-based routing + Wouter (client-side fallback)
- **Navigation:** Type-safe routing
- **Lazy Loading:** Code splitting automatique par route
- **Structure:** `app/` pour App Router (moderne)

### UI Components

- **Component Library:** Radix UI (headless, accessible)
  - Tous les composants pr√©fix√©s `@radix-ui/react-*`
- **Styling:** Tailwind CSS 3.4.17
  - Semantic colors system (success, warning, error, info families)
  - Dark/light variants disponibles
- **Design System:** shadcn/ui (composants construits sur Radix)
- **Icons:** Lucide React v0.453.0
- **Animations:** Framer Motion v11.13.1 + Tailwind animations

### Forms & Validation

- **Forms:** React Hook Form 7.55.0
- **Validation:** Zod 3.24.2
  - Schemas partag√©s avec backend (`shared/schema.ts`)
  - Type-safety garantie frontend ‚Üî backend
  - Validation c√¥t√© client + serveur
- **Error Handling:** Display erreurs Zod via composants de formulaire

### Data Fetching Pattern

```typescript
// client/src/hooks/use-ideas.ts
import { useQuery } from '@tanstack/react-query';

export function useIdeas() {
  return useQuery({
    queryKey: ['/api/ideas'],
    queryFn: async () => {
      const res = await fetch('/api/ideas');
      if (!res.ok) throw new Error('Failed to fetch');
      return res.json();
    },
    staleTime: 30000  // 30 secondes
  });
}

// Component usage:
export function IdeasList() {
  const { data: ideas, isLoading } = useIdeas();

  if (isLoading) return <div>Loading...</div>;

  return <div>...</div>;
}
```

### PWA Features

- **Service Workers:** `client/public/sw.js` + `client/public/sw-register.js`
- **Offline Mode:** Queue actions saved to IndexedDB
- **Push Notifications:** Web Push API avec VAPID keys
- **Installation:** Installable comme app native
- **Web App Manifest:** G√©n√©r√© via `npm run generate:config`

### Branding System

- **Core Config:** `client/src/config/branding-core.ts`
  - Centralis√©: textes, couleurs, logos, URLs
  - Objet JS (pas fichier JSON) pour flexibilit√©
- **Generation:** `npm run generate:config` cr√©e:
  - `index.html` avec m√©tadonn√©es
  - `manifest.json` (PWA manifest)
  - Config statique
- **Admin Interface:** `/admin/branding` (SUPER_ADMIN uniquement)
- **Semantic Colors:** 17 couleurs configurables (success, warning, error, info + variants dark/light)

---

## Backend

### Framework

- **NestJS:** 11.1.9 (migration compl√®te depuis Express ‚úÖ - janvier 2025)
- **TypeScript:** 5.6.3 (strict mode)
- **Runtime:** Node.js 20.x LTS
- **Entry Point:** `server/src/main.ts`
- **Alternative:** `bun --watch server/src/main.ts` (bun support)

### Architecture NestJS

#### Module Structure

```
server/src/
‚îú‚îÄ‚îÄ main.ts                    # Application bootstrap
‚îú‚îÄ‚îÄ app.module.ts              # Root module (imports tous les modules)
‚îú‚îÄ‚îÄ auth/                      # Authentication & authorization
‚îÇ   ‚îú‚îÄ‚îÄ auth.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts     # OAuth2 flow
‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ strategies/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ authentik.strategy.ts  # OAuth2 Authentik
‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.guard.ts      # Session-based auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ permission.guard.ts # Role-based permissions
‚îÇ   ‚îî‚îÄ‚îÄ decorators/
‚îÇ       ‚îî‚îÄ‚îÄ user.decorator.ts
‚îú‚îÄ‚îÄ ideas/                     # Gestion d'id√©es
‚îÇ   ‚îú‚îÄ‚îÄ ideas.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ ideas.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ ideas.service.ts
‚îú‚îÄ‚îÄ events/                    # Gestion d'√©v√©nements
‚îú‚îÄ‚îÄ members/                   # Gestion membres
‚îú‚îÄ‚îÄ patrons/                   # Gestion m√©c√®nes
‚îú‚îÄ‚îÄ loans/                     # Gestion pr√™ts d'objets
‚îú‚îÄ‚îÄ financial/                 # Gestion financi√®re
‚îú‚îÄ‚îÄ admin/                     # Interface administration
‚îú‚îÄ‚îÄ chatbot/                   # Services ChatBot
‚îú‚îÄ‚îÄ branding/                  # Configuration marque
‚îú‚îÄ‚îÄ integrations/              # Int√©grations externes
‚îÇ   ‚îî‚îÄ‚îÄ authentik/             # Service Authentik API
‚îú‚îÄ‚îÄ common/                    # Shared utilities
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.providers.ts  # Drizzle DB injection
‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îú‚îÄ‚îÄ interceptors/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logging.interceptor.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitor.interceptor.ts
‚îÇ   ‚îú‚îÄ‚îÄ filters/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ http-exception.filter.ts
‚îÇ   ‚îî‚îÄ‚îÄ decorators/
‚îî‚îÄ‚îÄ tracking/                  # Tracking & analytics
```

#### Dependency Injection

- **Pattern:** Constructor-based DI uniquement
- **Scopes:** Singleton par d√©faut
- **Custom Providers:**
  - `DB` token pour injection Drizzle
  - Services sp√©cialis√©s (Authentik, MinIO, etc.)

#### Guards & Interceptors

- **AuthGuard:** Session-based (Express sessions)
  - V√©rifie req.user existant
  - D√©corateur `@User()` pour acc√©der √† l'utilisateur
- **PermissionGuard:** Role-based authorization
  - D√©corateur `@Permissions('role1', 'role2')`
  - R√¥les: SUPER_ADMIN, ideas_manager, events_manager, finance_manager, etc.
- **LoggingInterceptor:** Log HTTP requests/responses
- **MonitorInterceptor:** DB query monitoring (logs)
- **HttpExceptionFilter:** Exception handling global

#### Validation & Pipes

- **ValidationPipe:** Auto-validation DTOs globales
- **Pattern:** DTO classes avec class-validator decorators
```typescript
import { IsString, IsNotEmpty, IsEnum } from 'class-validator';

export class CreateIdeaDto {
  @IsString()
  @IsNotEmpty()
  title: string;

  @IsString()
  @IsOptional()
  description?: string;

  @IsEnum(IDEA_STATUS)
  status: string;
}
```

### Database

#### ORM & Schema

- **ORM:** Drizzle ORM 0.39.1 (type-safe, performant)
- **Database:** PostgreSQL 16
  - **Dev:** localhost:5436 (docker-compose.services.yml)
  - **Prod:** Neon cloud provider
- **Schema Location:** `shared/schema.ts` (source unique de v√©rit√©)
- **Connection:** Drizzle sur Neon HTTP (serverless compatible)

#### Schema Pattern

```typescript
// shared/schema.ts
import { pgTable, varchar, text, timestamp, boolean } from 'drizzle-orm/pg-core';
import { createInsertSchema, createSelectSchema } from 'drizzle-zod';

export const ideas = pgTable('ideas', {
  id: varchar('id').primaryKey().default(sql`gen_random_uuid()`),
  title: text('title').notNull(),
  description: text('description'),
  status: varchar('status').notNull().default('PENDING'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
});

export type Idea = typeof ideas.$inferSelect;
export type NewIdea = typeof ideas.$inferInsert;

export const insertIdeaSchema = createInsertSchema(ideas);
export const selectIdeaSchema = createSelectSchema(ideas);
```

#### Tables Principales

- `admins` - Administrateurs (synced depuis Authentik)
- `ideas` - Id√©es propos√©es
- `votes` - Votes sur id√©es
- `events` - √âv√©nements
- `inscriptions` - Inscriptions √©v√©nements
- `members` - Membres
- `patrons` - M√©c√®nes/sponsors
- `loan_items` - Objets pr√™tables
- `budgets` - Budgets financiers
- `expenses` - D√©penses
- `tracking_items` - Items de tracking

#### Query Patterns

```typescript
// Injection
constructor(@Inject('DB') private db: Database) {}

// Select
const ideas = await this.db.query.ideas.findMany();
const idea = await this.db.query.ideas.findFirst({ where: eq(ideas.id, id) });

// Insert
const newIdea = await this.db.insert(ideas).values({ title, description }).returning();

// Update
await this.db.update(ideas).set({ status: 'APPROVED' }).where(eq(ideas.id, id));

// Delete
await this.db.delete(ideas).where(eq(ideas.id, id));

// Transactions
await this.db.transaction(async (tx) => {
  // Multiple operations
});
```

#### Migrations

```bash
# Push schema changes to database
npm run db:push

# Connect to database (psql)
npm run db:connect

# View database statistics
npm run db:stats

# Monitor connections
npm run db:monitor
```

### Authentication & Authorization

#### Provider

- **Service:** Authentik (self-hosted OAuth2/OIDC)
  - **Docker:** `docker-compose.services.yml`
  - **Interface:** http://localhost:9002
- **Strategy:** OAuth2 Authorization Code Flow
- **Session Store:** PostgreSQL (connect-pg-simple)
- **Session Duration:** 7 jours

#### Configuration

```bash
# Environment variables
AUTHENTIK_BASE_URL=http://localhost:9002
AUTHENTIK_CLIENT_ID=...
AUTHENTIK_CLIENT_SECRET=...
AUTHENTIK_ISSUER=http://localhost:9002/application/o/cjd80/
AUTHENTIK_REDIRECT_URI=http://localhost:5000/api/auth/authentik/callback
AUTHENTIK_TOKEN=...  # API token for user sync
SESSION_SECRET=...
```

#### Flow

1. User clicks "Login" ‚Üí Redirect to Authentik
2. Authentik authentication ‚Üí User approves
3. Callback to `/api/auth/authentik/callback`
4. Exchange code for tokens
5. Fetch user profile & groups from Authentik
6. Sync user to local `admins` table
7. Create session in PostgreSQL
8. Redirect with session cookie

#### User Synchronization

- **Trigger:** Chaque login
- **Service:** `server/src/auth/user-sync.service.ts`
- **Mapping:**
  - Authentik ID ‚Üí local user ID
  - Groups ‚Üí Roles (super_admin, ideas_manager, etc.)
  - Email, name, avatar synced

#### Authorization Patterns

```typescript
// Controller method avec guards
@Controller('api/admin/ideas')
@UseGuards(AuthGuard)
export class AdminIdeasController {
  @Get()
  @UseGuards(PermissionGuard)
  @Permissions('super_admin', 'ideas_manager')
  async findAll() { ... }

  @Get(':id')
  @UseGuards(AuthGuard)  // Just require auth
  async findOne(@Param('id') id: string) { ... }
}

// Getting current user
@Get('profile')
@UseGuards(AuthGuard)
async getProfile(@User() user: Admin) {
  return user;
}
```

---

## Self-Hosted Services

### PostgreSQL

- **Image:** postgres:16-alpine
- **Container:** `cjd-postgres`
- **Port:** 5436 (√©viter conflits)
- **Volume:** `postgres-data`
- **Healthcheck:** pg_isready

### MinIO (Object Storage)

- **Image:** minio/minio:latest
- **Container:** `cjd-minio`
- **API Port:** 9000
- **Console Port:** 9001
- **Volume:** `minio-data`
- **Buckets:**
  - `loan-items` - Fichiers pr√™ts
  - `assets` - Assets uploads
- **Usage:** Stockage documents, images, fichiers
- **SDK:** minio npm package

### Redis

- **Image:** redis:7-alpine
- **Container:** `cjd-redis`
- **Port:** 6381 (√©viter conflits)
- **Volume:** `redis-data`
- **Usage:** Cache + sessions
- **Optional Password:** Configurable via env

### Authentik (Identity Provider)

- **Image:** beryju/authentik:2024.10.1
- **Container:** `cjd-authentik-server`
- **Ports:**
  - 9002 (HTTP)
  - 9443 (HTTPS)
- **Dependencies:** PostgreSQL + Redis
- **Volumes:**
  - `/media` - M√©dias
  - `/certs` - Certificats SSL
- **Configuration:** Web UI http://localhost:9002

### HelloAsso Integration

- **Purpose:** Gestion inscriptions √©v√©nements
- **API:** REST API de HelloAsso
- **Pattern:** Int√©gration via services (√Ä d√©terminer en d√©tail)
- **Config:** Variables d'environnement HelloAsso (√Ä d√©terminer)

---

## Development Commands

### Setup Initial

```bash
# Installation d√©pendances
npm install

# D√©marrer services Docker (PostgreSQL, MinIO, Redis, Authentik)
docker compose -f docker-compose.services.yml up -d

# Migrations base de donn√©es
npm run db:push

# Configuration Authentik (auto-setup)
./scripts/setup-authentik.sh
```

### Development

```bash
# Full dev (frontend + backend)
npm run start:dev

# Frontend only (Vite on :5173)
npm run dev:client

# Backend only (NestJS on :5000)
npm run dev:next  # Next.js SSR
npm run dev:nest  # NestJS backend

# Type checking
npm run check

# Linting
npm run lint
```

### Database

```bash
# Push schema changes
npm run db:push

# Connect to database
npm run db:connect

# Monitor connections
npm run db:monitor

# View statistics
npm run db:stats

# Create specific tables (legacy)
npm run db:create-loan-table
npm run db:create-financial-tables
```

### Docker & Deployment

```bash
# Manage Docker
./scripts/docker-manage.sh
./scripts/docker-monitor.sh
./scripts/docker-backup.sh

# Dev Docker
./scripts/docker-dev.sh

# Deploy
./scripts/quick-deploy.sh
./scripts/deploy-full.sh
npm run deploy

# Monitor
./scripts/monitor-app.sh
npm run health
npm run health:check
```

### SSH & Remote

```bash
# Setup SSH access
npm run ssh:setup

# Connect to remote
npm run ssh:connect

# Mount remote filesystem
npm run ssh:mount
npm run ssh:unmount

# Sync files
npm run ssh:sync

# SSH Tunnel
npm run ssh:tunnel
```

### GitHub Operations

```bash
# Auth
npm run gh:auth

# Create PR
npm run gh:pr

# Deploy via Actions
npm run gh:deploy

# View Actions status
npm run gh:actions
```

### Build & Production

```bash
# Build (Next.js + NestJS backend)
npm run build

# Start production server
npm start

# Validate app health
npm run validate

# Generate config (branding)
npm run generate:config

# Clean all
npm run clean:all

# Reset environment (WARNING: deletes data)
npm run reset:env
```

### Testing & Validation

```bash
# Tests (Vitest)
npm test
npm run test:watch
npm run test:coverage

# Playwright E2E
npm run test:playwright
npm run test:analyze
npm run test:maintenance

# Validation
npm run validate
npm run validate:env
npm run validate:nestjs

# Health check
npm run health:check

# Check dependencies
npm run check:deps

# Analyze migration
npm run analyze:migration
```

### Maintenance

```bash
# Maintenance mode
npm run maintenance

# Test startup
npm run test:startup

# Migrate to MinIO
npm run migrate:minio
npm run migrate:minio:delete
```

---

## Environment Variables

### Core Configuration

```bash
# App
NODE_ENV=production|development
PORT=5000

# Database (PostgreSQL)
DATABASE_URL=postgresql://user:password@host:port/database
```

### Session & Security

```bash
SESSION_SECRET=your-strong-secret-key
```

### Push Notifications (PWA)

```bash
VAPID_PUBLIC_KEY=...
VAPID_PRIVATE_KEY=...
VAPID_MAILTO=mailto:admin@cjd80.fr
```

### Authentik OAuth2

```bash
AUTHENTIK_BASE_URL=http://localhost:9002
AUTHENTIK_CLIENT_ID=...
AUTHENTIK_CLIENT_SECRET=...
AUTHENTIK_ISSUER=http://localhost:9002/application/o/cjd80/
AUTHENTIK_REDIRECT_URI=http://localhost:5000/api/auth/authentik/callback
AUTHENTIK_TOKEN=...
```

### MinIO (Object Storage)

```bash
MINIO_ENDPOINT=localhost
MINIO_PORT=9000
MINIO_EXTERNAL_PORT=9002
MINIO_USE_SSL=false
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET_LOAN_ITEMS=loan-items
MINIO_BUCKET_ASSETS=assets
```

### Redis

```bash
REDIS_URL=redis://localhost:6381
REDIS_PASSWORD=  # Optional
```

### GitHub (Optional)

```bash
GITHUB_TOKEN=ghp_...
GITHUB_REPO_OWNER=Aoleon
GITHUB_REPO_NAME=cjd80
```

### Email (Optional - SMTP)

```bash
SMTP_USER=your-email@example.com
SMTP_PASSWORD=your-smtp-password
```

---

## Deployment

### Docker

- **Dockerfile:** Multi-stage build (Node.js + Next.js)
- **Compose:**
  - `docker-compose.yml` - Production (avec Traefik)
  - `docker-compose.dev.yml` - Development
  - `docker-compose.services.yml` - Services (PostgreSQL, MinIO, Redis, Authentik)
  - `docker-compose.prod.yml` - Alternative production

### Reverse Proxy

- **Tool:** Traefik
- **Config:** Labels in docker-compose.yml
- **Domain:** `cjd80.fr` (production) / `cjd80.rbw.ovh` (dev)
- **SSL:** Let's Encrypt (letsencrypt certresolver)

### Health Check

```bash
# Docker health
docker ps  # Status = healthy

# Application health
curl http://localhost:5000/api/health

# Database
npm run db:monitor

# Services
docker compose -f docker-compose.services.yml ps
```

---

## Project-Specific Conventions

### File Naming

- **Backend:** `kebab-case.ts` pour fichiers, `PascalCase` pour classes
- **Frontend:** `PascalCase.tsx` pour composants, `kebab-case.ts` pour hooks/utils
- **Shared:** `kebab-case.ts` pour schemas et utilities

### Import Aliases

- `@/` ‚Üí `client/src/` ou `app/` (frontend code)
- `@shared/` ‚Üí `shared/` (shared types/schemas)
- `@assets/` ‚Üí `assets/` (static files)

### Semantic Colors

Utiliser classes s√©mantiques au lieu de couleurs hardcoded:

```tsx
// ‚úÖ BON
<div className="bg-success text-white">Success</div>
<div className="bg-error text-white">Error</div>
<div className="border-warning">Warning</div>

// ‚ùå MAUVAIS
<div className="bg-green-500">Success</div>
<div className="bg-red-500">Error</div>
```

**Variants disponibles:**
- Success: `bg-success`, `text-success`, `border-success`, `bg-success-dark`, `bg-success-light`
- Error: `bg-error`, `text-error`, `border-error`, etc.
- Warning: `bg-warning`, `text-warning`, `border-warning`, etc.
- Info: `bg-info`, `text-info`, `border-info`, etc.

### Status Constants

Toujours utiliser les constantes de `shared/schema.ts`:

```typescript
// ‚úÖ BON
import { IDEA_STATUS } from '@shared/schema';
if (idea.status === IDEA_STATUS.APPROVED) { ... }

// ‚ùå MAUVAIS
if (idea.status === 'APPROVED') { ... }
```

**Available Constants:**
- `IDEA_STATUS` (PENDING, APPROVED, REJECTED, ARCHIVED)
- `EVENT_STATUS` (DRAFT, PUBLISHED, CLOSED, CANCELLED)
- `LOAN_STATUS` (AVAILABLE, BORROWED, RETURNED, DAMAGED)
- `ADMIN_ROLES` (SUPER_ADMIN, ideas_manager, events_manager, finance_manager)

---

## Key Files Reference

### Architecture & Bootstrap

- `server/src/main.ts` - Application bootstrap
- `server/src/app.module.ts` - Module imports & global config
- `shared/schema.ts` - Database schema & validation (source unique de v√©rit√©)

### Authentication

- `server/src/auth/auth.module.ts` - Passport & session config
- `server/src/auth/strategies/authentik.strategy.ts` - OAuth2 Authentik
- `server/src/auth/guards/auth.guard.ts` - Session auth
- `server/src/auth/guards/permission.guard.ts` - Role-based permissions
- `server/src/integrations/authentik/authentik.service.ts` - Authentik API client

### Frontend

- `client/src/App.tsx` ou `app/page.tsx` - Main app
- `client/src/hooks/` - TanStack Query hooks
- `client/src/lib/branding.ts` - Branding helpers
- `client/src/config/branding-core.ts` - Branding configuration

### Configuration

- `client/src/config/branding-core.ts` - Branding config
- `docker-compose.services.yml` - Services (PostgreSQL, MinIO, Redis, Authentik)
- `.env.example` - Environment variables template
- `next.config.js` - Next.js configuration
- `tsconfig.json` - Frontend TypeScript config
- `tsconfig.server.json` - Backend TypeScript config

### Scripts

- `scripts/start-dev.sh` - Automated dev setup
- `scripts/setup-authentik.sh` - Authentik auto-configuration
- `scripts/quick-deploy.sh` - Quick deployment
- `scripts/deploy-full.sh` - Full deployment with validation

---

## Standards Compliance

‚úÖ **Stack Moderne 100%:**
- NestJS 11 backend (migrated from Express)
- Drizzle ORM for database
- TanStack Query for frontend state
- Radix UI + Tailwind CSS for UI
- Next.js for frontend framework
- TypeScript strict mode
- OAuth2/OIDC authentication (Authentik)
- Progressive Web App support

---

## Exceptions & Divergences

### React + Next.js (au lieu de React + Vite seul)

**Raison:**
- Support SSR (Server-Side Rendering) natif
- Image optimization int√©gr√©e
- API routes convenantes (m√™me si NestJS pr√©f√©r√©)
- File-based routing simpler

**Implication:**
- Build process via Next.js
- D√©ploiement include serveur Next.js
- Configuration via `next.config.js`

---

---

## Migrations Planifi√©es

### Priorit√©: üî¥ HAUTE

#### √âtat Actuel

| Package | Version | √âtat |
|---------|---------|------|
| Next.js | 15.1.4 | √Ä migrer ‚Üí 16 |
| NestJS | 11.1.9 | ‚úÖ √Ä jour |
| Zod | v3.24.2 | √Ä migrer ‚Üí v4 |
| API | tRPC uniquement | √Ä remplacer par OpenAPI/REST |

#### T√¢ches de Migration

**1. [ ] Upgrade Next.js 15 ‚Üí 16 + Turbopack**
- Version cible: Next.js 16.x (latest stable)
- Activer Turbopack dans `next.config.js`
- Validation: `npm run build` doit passer sans erreurs
- Tests: E2E Playwright suite compl√®te
- Dur√©e estim√©e: 2-3 jours
- Impact: Performance +40% en dev build

**Checklist technique:**
- [ ] Mettre √† jour `package.json` (Next.js 16)
- [ ] Remplacer `next/swc` par Turbopack config
- [ ] V√©rifier compatibilit√© plugins Webpack
- [ ] Tester routes API Next.js (remplacer par NestJS endpoints)
- [ ] Valider SSR + SSG patterns
- [ ] Tests Playwright complets
- [ ] V√©rifier middlewares Next.js
- [ ] Build optimisation (tree-shaking)

---

**2. [ ] Migrer Zod v3 ‚Üí v4 (Breaking Changes)**
- Version cible: Zod v4.x (latest)
- Gestion des breaking changes (√† tester)
- Mise √† jour schemas partag√©s: `shared/schema.ts`
- Validation: Type-safety garantie

**Breaking Changes Known:**
- API de validation peut changer
- M√©thodes d√©pr√©ci√©es supprim√©es
- Nouveaux types de validateurs
- Performance am√©lior√©e

**Checklist technique:**
- [ ] Lire changelog Zod v4 complet
- [ ] Tester schemas existants
- [ ] Adapter `createInsertSchema` + `createSelectSchema` si n√©cessaire
- [ ] Valider validation c√¥t√© client (React Hook Form)
- [ ] Valider validation c√¥t√© serveur (NestJS DTOs)
- [ ] Tests unitaires pour chaque schema
- [ ] Mettre √† jour drizzle-zod si n√©cessaire
- [ ] Documenter changes dans CHANGELOG.md

---

**3. [ ] Ajouter @nestjs/swagger pour OpenAPI**
- Package: `@nestjs/swagger` + `swagger-ui-express`
- Objective: Documenter API REST automatiquement
- Endpoint UI: `/api/docs` (Swagger UI)
- Fichier JSON: `/api/docs-json` (OpenAPI spec)

**Installation:**
```bash
npm install @nestjs/swagger swagger-ui-express
npm install -D @types/swagger-ui-express
```

**Configuration dans `server/src/main.ts`:**
```typescript
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';

const config = new DocumentBuilder()
  .setTitle('CJD80 API')
  .setDescription('API REST for CJD80 "Bo√Æte √† Kiffs"')
  .setVersion('1.0')
  .addBearerAuth()  // Si OAuth2 Bearer tokens
  .build();

const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup('api/docs', app, document);
```

**D√©coration des DTOs:**
```typescript
import { ApiProperty } from '@nestjs/swagger';

export class CreateIdeaDto {
  @ApiProperty({ description: 'Titre de l\'id√©e', example: 'Nouvelle feature' })
  @IsString()
  @IsNotEmpty()
  title: string;

  @ApiProperty({ description: 'Description optionnelle' })
  @IsString()
  @IsOptional()
  description?: string;

  @ApiProperty({ enum: IDEA_STATUS })
  @IsEnum(IDEA_STATUS)
  status: string;
}
```

**D√©coration des endpoints:**
```typescript
@Get('ideas')
@ApiOperation({ summary: 'Liste toutes les id√©es' })
@ApiResponse({
  status: 200,
  description: 'Liste des id√©es',
  type: [IdeaDto]
})
async findAll(): Promise<Idea[]> { ... }
```

**Checklist technique:**
- [ ] Installer `@nestjs/swagger` + d√©pendances
- [ ] Configurer Swagger module dans `main.ts`
- [ ] D√©corer tous les DTOs avec `@ApiProperty`
- [ ] D√©corer tous les endpoints avec `@ApiOperation`, `@ApiResponse`
- [ ] Tester UI Swagger: http://localhost:5000/api/docs
- [ ] Exporter OpenAPI spec JSON
- [ ] Documenter authentification dans Swagger
- [ ] Ajouter tags par module (ideas, events, admin, etc.)

---

**4. [ ] Cr√©er REST Endpoints √âquivalents aux Routes tRPC**
- Strat√©gie: Ajouter routes NestJS parall√®lement aux tRPC
- Approche graduelle: 1-2 modules par semaine
- Cible: 100% REST API, 0% tRPC

**Modules √† migrer (ordre prioritaire):**
1. Ideas Module (CRUD principal)
2. Events Module (Gestion √©v√©nements)
3. Members Module (Gestion membres)
4. Admin Module (Interface admin)
5. Financial Module (Gestion financi√®re)

**Exemple migration Ideas module:**

**Avant (tRPC):**
```typescript
// client/src/hooks/use-ideas.ts
export function useIdeas() {
  return useQuery({
    queryKey: ['/trpc/ideas'],
    queryFn: async () => {
      return trpc.ideas.findAll.query();
    }
  });
}
```

**Apr√®s (REST + Swagger):**
```typescript
// server/src/ideas/ideas.controller.ts
@Controller('api/ideas')
@UseGuards(AuthGuard)
export class IdeasController {
  constructor(private ideasService: IdeasService) {}

  @Get()
  @ApiOperation({ summary: 'Lister toutes les id√©es' })
  @ApiResponse({ status: 200, type: [IdeaDto] })
  async findAll(): Promise<Idea[]> {
    return this.ideasService.findAll();
  }

  @Get(':id')
  @ApiOperation({ summary: 'R√©cup√©rer une id√©e par ID' })
  @ApiResponse({ status: 200, type: IdeaDto })
  @ApiResponse({ status: 404, description: 'Id√©e non trouv√©e' })
  async findOne(@Param('id') id: string): Promise<Idea> {
    return this.ideasService.findOne(id);
  }

  @Post()
  @UseGuards(PermissionGuard)
  @Permissions('super_admin', 'ideas_manager')
  @ApiOperation({ summary: 'Cr√©er une nouvelle id√©e' })
  @ApiResponse({ status: 201, type: IdeaDto })
  async create(@Body() createIdeaDto: CreateIdeaDto): Promise<Idea> {
    return this.ideasService.create(createIdeaDto);
  }

  @Put(':id')
  @UseGuards(PermissionGuard)
  @Permissions('super_admin', 'ideas_manager')
  @ApiOperation({ summary: 'Mettre √† jour une id√©e' })
  @ApiResponse({ status: 200, type: IdeaDto })
  async update(
    @Param('id') id: string,
    @Body() updateIdeaDto: UpdateIdeaDto
  ): Promise<Idea> {
    return this.ideasService.update(id, updateIdeaDto);
  }

  @Delete(':id')
  @UseGuards(PermissionGuard)
  @Permissions('super_admin', 'ideas_manager')
  @ApiOperation({ summary: 'Supprimer une id√©e' })
  @ApiResponse({ status: 204 })
  async remove(@Param('id') id: string): Promise<void> {
    await this.ideasService.remove(id);
  }
}
```

**Client update:**
```typescript
// client/src/hooks/use-ideas.ts
export function useIdeas() {
  return useQuery({
    queryKey: ['/api/ideas'],
    queryFn: async () => {
      const res = await fetch('/api/ideas');
      if (!res.ok) throw new Error('Failed to fetch ideas');
      return res.json();
    }
  });
}

export function useCreateIdea() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (data: CreateIdeaDto) => {
      const res = await fetch('/api/ideas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('Failed to create idea');
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/ideas'] });
    }
  });
}
```

**Checklist technique (par module):**
- [ ] Cr√©er DTOs (CreateXxxDto, UpdateXxxDto, XxxDto)
- [ ] Ajouter `@ApiProperty` sur tous les champs
- [ ] Impl√©menter endpoints GET, POST, PUT, DELETE
- [ ] Ajouter guards & permissions appropri√©s
- [ ] D√©corer avec `@ApiOperation`, `@ApiResponse`
- [ ] Tester endpoints via Swagger UI
- [ ] Mettre √† jour hooks client (React Query)
- [ ] Tests unitaires NestJS
- [ ] Tests E2E Playwright
- [ ] Valider avec clients existants

---

**5. [ ] Supprimer tRPC Progressivement**
- Apr√®s 100% endpoints REST cr√©√©s
- Strat√©gie: Garder tRPC en place jusqu'√† migration compl√®te
- √âtape finale: Supprimer d√©pendances tRPC

**D√©pendances tRPC √† supprimer:**
```json
{
  "dependencies": {
    "@trpc/client": "delete",
    "@trpc/server": "delete",
    "@trpc/react-query": "delete"
  }
}
```

**Fichiers √† supprimer:**
```
server/src/trpc/
client/src/lib/trpc.ts
client/src/hooks/trpc/
```

**Checklist technique:**
- [ ] V√©rifier tous les endpoints REST sont actifs
- [ ] Auditer tous les appels tRPC dans frontend
- [ ] Remplacer par fetch/React Query
- [ ] Supprimer d√©pendances tRPC du package.json
- [ ] Supprimer fichiers tRPC
- [ ] Nettoyer imports tRPC
- [ ] Tests complets E2E
- [ ] Valider production sans tRPC

---

### Timeline & D√©pendances

```
Semaine 1: Next.js 15 ‚Üí 16 + Turbopack
  ‚îî‚îÄ Parall√®le: Audit breaking changes Zod v4

Semaine 2-3: Zod v3 ‚Üí v4
  ‚îî‚îÄ Mise √† jour schemas
  ‚îî‚îÄ Tests validation

Semaine 4-5: @nestjs/swagger setup
  ‚îî‚îÄ DTOs decoration
  ‚îî‚îÄ Endpoints documentation

Semaine 6-10: REST Endpoints creation (5 modules)
  ‚îî‚îÄ Ideas (2j)
  ‚îî‚îÄ Events (2j)
  ‚îî‚îÄ Members (1j)
  ‚îî‚îÄ Admin (2j)
  ‚îî‚îÄ Financial (2j)

Semaine 11-12: tRPC removal
  ‚îî‚îÄ Cleanup final
  ‚îî‚îÄ Validation production

Total estim√©: 12 semaines
```

### Validation Avant Merge

```bash
# TypeScript strict
npx tsc --noEmit  # exit 0

# Tests
npm test           # 100% pass
npm run test:playwright  # E2E complete

# Build
npm run build      # success

# Docker health
docker compose -f docker-compose.services.yml ps  # all healthy
docker ps | grep cjd  # running

# API docs
curl http://localhost:5000/api/docs  # 200 OK

# OpenAPI spec
curl http://localhost:5000/api/docs-json  # valid spec
```

---

## Documentation Compl√®te

**Fichiers principaux:**
- `CLAUDE.md` - Patterns et bonnes pratiques d√©taill√©s
- `README.md` - Documentation projet complet
- `docs/` - Documentation technique organis√©e
- `docs/deployment/` - Guides de d√©ploiement
- `docs/features/` - Documentation features
- `docs/migration/` - Reports migrations (NestJS, Authentik)

