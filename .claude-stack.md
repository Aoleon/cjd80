# Stack Technique - CJD Amiens "Boîte à Kiffs"

## Technologies

### Backend
- **Framework:** NestJS 11 (migrated from Express.js, January 2025)
- **Language:** TypeScript
- **ORM:** Drizzle ORM
- **Database:** PostgreSQL (Neon cloud provider) with connection pooling
- **Testing:** Playwright (E2E tests)

### Frontend
- **Framework:** React 18 + TypeScript
- **Build:** Vite
- **State Management:** TanStack Query v5 (server state)
- **Routing:** Wouter (lightweight routing)
- **UI:** Tailwind CSS + shadcn/ui components
- **Forms:** React Hook Form
- **PWA:** Service workers, offline queue, push notifications

### Infrastructure & Services

**Authentication:**
- Authentik (OAuth2/OIDC provider)
- Session-based authentication
- Docker Compose for local development

**Storage:**
- MinIO (S3-compatible object storage)

**Integrations:**
- HelloAsso API (event ticket management)
- Authentik API (user/group management)

### Database
- PostgreSQL 16+
- Neon cloud provider
- Connection pooling
- Session store (connect-pg-simple)

## Architecture

### NestJS Migration Status

The backend has been **fully migrated from Express.js to NestJS** (January 2025).

**Key Characteristics:**
- **11 feature modules** organized by domain
- **Dependency injection** throughout (constructor-based)
- **Main entry:** `server/src/main.ts` bootstraps the NestJS app
- **App module:** `server/src/app.module.ts` imports all feature modules
- **Controllers** handle HTTP requests
- **Services** contain business logic
- **Guards** for authentication and permissions
- **Interceptors** for logging and DB monitoring (global)
- **Filters** for exception handling (`HttpExceptionFilter`)

**Module Structure Pattern:**
```
server/src/{feature}/
├── {feature}.module.ts       # Feature module
├── {feature}.controller.ts   # HTTP endpoints
└── {feature}.service.ts      # Business logic
```

**Feature Modules:**
1. **AuthModule** - Authentication via Authentik OAuth2
2. **IdeasModule** - Collaborative idea management with voting
3. **EventsModule** - Event management with HelloAsso integration
4. **AdminModule** - Administration interface
5. **MembersModule** - Member CRM
6. **PatronsModule** - Sponsor/patron management
7. **LoansModule** - Equipment loan tracking
8. **FinancialModule** - Budget and expense management
9. **TrackingModule** - Activity tracking
10. **ChatbotModule** - Conversational interface
11. **BrandingModule** - Customizable branding system

### Authentik Integration

Authentication is handled by **Authentik** (external OAuth2/OIDC provider):

**Architecture:**
- **Strategy:** `server/src/auth/strategies/authentik.strategy.ts` using Passport OAuth2
- **User sync:** Automatic synchronization from Authentik to local `admins` table
- **Group mapping:** Authentik groups → application roles (super_admin, ideas_manager, events_manager, etc.)
- **Session-based:** Express sessions stored in PostgreSQL (connect-pg-simple)
- **Docker services:** PostgreSQL, Redis, Authentik server/worker in `docker-compose.services.yml`

**Configuration:**
- Environment variables: `AUTHENTIK_CLIENT_ID`, `AUTHENTIK_CLIENT_SECRET`, `AUTHENTIK_ISSUER`, `AUTHENTIK_REDIRECT_URI`
- Callback URL: `http://localhost:5000/api/auth/authentik/callback`

**Critical Files:**
- `server/src/auth/auth.module.ts` - Passport configuration
- `server/src/auth/user-sync.service.ts` - User synchronization logic
- `server/src/integrations/authentik/authentik.service.ts` - Authentik API client

### Database Architecture

**Drizzle ORM** with PostgreSQL:

**Schema:**
- Single source of truth: `shared/schema.ts`
- Type-safe queries
- Zod validation schemas derived from tables

**Core Tables:**
- `admins` - User accounts (synced from Authentik)
- `ideas` - Collaborative ideas with voting system
- `votes` - Idea votes from members
- `events` - Event management
- `inscriptions` - Event registrations (HelloAsso integration)
- `members` - CRM for organization members
- `patrons` - Sponsors and partners
- `loan_items` - Equipment loan tracking
- `budgets` - Financial budgets
- `expenses` - Expense tracking
- `tracking_items` - Activity tracking

**Connection:**
- Injectable `DB` token provided by `database.providers.ts`
- Connection pooling for performance
- Session store integration

**Key Patterns:**
- Use Drizzle query builders (not raw SQL)
- Validation schemas from `createInsertSchema()`
- Indexes on frequently queried columns (status, email, dates)
- Cascade deletes for referential integrity

**Migrations:**
- Run `npm run db:push` to sync schema changes to database

### Shared Types and Validation

The `shared/` directory contains types used by **both frontend and backend**:

**Files:**
- `shared/schema.ts` - Drizzle tables, Zod schemas, TypeScript types
- `shared/errors.ts` - Custom error types

**Pattern:**
1. Define table in `shared/schema.ts`
2. Export insert/select schemas (Zod)
3. Run `npm run db:push` to apply database changes
4. Use types in both backend (controllers/services) and frontend (components/hooks)

**Example:**
```typescript
// shared/schema.ts
export const myTable = pgTable("my_table", {
  id: varchar("id").primaryKey(),
  title: text("title").notNull()
});

export const insertMyTableSchema = createInsertSchema(myTable);
export type MyTable = typeof myTable.$inferSelect;
export type InsertMyTable = typeof myTable.$inferInsert;
```

### Frontend Architecture

**State Management:**

**TanStack Query** for server state:
- **Hooks pattern:** `client/src/hooks/use-*.ts` - Custom hooks for data fetching
- **Queries:** `useQuery` for GET operations (auto-cached, auto-revalidated)
- **Mutations:** `useMutation` for POST/PUT/DELETE with optimistic updates
- **Query invalidation:** Mutations automatically invalidate related queries

**Example Pattern:**
```typescript
// Hook: client/src/hooks/use-ideas.ts
export function useIdeas() {
  return useQuery({
    queryKey: ["/api/ideas"],
    queryFn: async () => {
      const res = await fetch("/api/ideas");
      return res.json();
    }
  });
}

// Component usage:
const { data: ideas, isLoading } = useIdeas();
```

**Component Structure:**
- Pages in `client/src/pages/`
- Reusable components in `client/src/components/`
- UI components (shadcn/ui) in `client/src/components/ui/`
- Custom hooks in `client/src/hooks/`
- Utilities in `client/src/lib/`

### Branding System

**Centralized configuration** for multi-tenant-ready customization:

**Architecture:**
- **Core config:** `client/src/config/branding-core.ts` - All text, colors, logos (JavaScript object)
- **Generation script:** `npm run generate:config` creates `index.html` and `manifest.json`
- **Admin interface:** `/admin/branding` route allows SUPER_ADMIN to modify branding
- **Semantic colors:** 17 configurable colors (success, warning, error, info families)
- **Helper functions:** `client/src/lib/branding.ts` for accessing branding values

**Semantic Color System:**

Each color family has base + dark + light variants:
- **Success:** `bg-success`, `bg-success-dark`, `bg-success-light`
- **Warning:** `bg-warning`, `bg-warning-dark`, `bg-warning-light`
- **Error:** `bg-error`, `bg-error-dark`, `bg-error-light`
- **Info:** `bg-info`, `bg-info-dark`, `bg-info-light`
- **Primary:** `bg-primary`, `bg-primary-dark`, `bg-primary-light`

**Configuration in `client/src/index.css`:**
```css
:root {
  --color-success: 74 222 128;  /* green-400 */
  --color-success-dark: 34 197 94;  /* green-500 */
  --color-success-light: 134 239 172;  /* green-300 */
  /* ... */
}
```

### PWA Service Worker

**Offline-first capabilities:**
- Actions saved to IndexedDB when offline
- Auto-sync every hour or when connection returns
- Offline banner shows network status
- Push notifications support

**Files:**
- `client/public/sw.js` - Service worker implementation
- `client/public/sw-register.js` - Registration script
- `client/public/manifest.json` - PWA manifest

**Features:**
- Offline queue for mutations
- Cache-first strategy for static assets
- Network-first strategy for API calls
- Background sync

## Environment Variables

**Required for development:**

```bash
# Database
DATABASE_URL=postgresql://user:pass@host:port/database

# Session
SESSION_SECRET=generate-strong-secret-key

# Authentik OAuth2
AUTHENTIK_BASE_URL=http://localhost:9002
AUTHENTIK_CLIENT_ID=your-client-id
AUTHENTIK_CLIENT_SECRET=your-client-secret
AUTHENTIK_ISSUER=http://localhost:9002/application/o/cjd80/
AUTHENTIK_REDIRECT_URI=http://localhost:5000/api/auth/authentik/callback
AUTHENTIK_TOKEN=your-authentik-api-token

# MinIO (optional)
MINIO_ENDPOINT=localhost
MINIO_PORT=9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
```

**Setup:**
1. Copy `.env.example` to `.env`
2. Start Docker services: `docker compose -f docker-compose.services.yml up -d`
3. Configure Authentik via web UI at http://localhost:9002
4. Fill in Authentik variables from UI
5. Run `npm run start:dev`

## Import Aliases

Configured in `tsconfig.json`:

- `@/` → `client/src/` (frontend code)
- `@shared/` → `shared/` (shared types/schemas)

**Usage:**
```typescript
// Frontend
import { Button } from "@/components/ui/button";
import type { Idea } from "@shared/schema";

// Backend
import { insertIdeaSchema } from "@shared/schema";
```

## Status Constants

Always use constants from `shared/schema.ts` for type safety:

**Ideas:**
- `IDEA_STATUS.PENDING`
- `IDEA_STATUS.APPROVED`
- `IDEA_STATUS.REJECTED`
- `IDEA_STATUS.IN_PROGRESS`
- `IDEA_STATUS.COMPLETED`

**Events:**
- `EVENT_STATUS.DRAFT`
- `EVENT_STATUS.PUBLISHED`
- `EVENT_STATUS.CANCELLED`
- `EVENT_STATUS.COMPLETED`

**Loans:**
- `LOAN_STATUS.AVAILABLE`
- `LOAN_STATUS.BORROWED`
- `LOAN_STATUS.RETURNED`
- `LOAN_STATUS.DAMAGED`

**Admins:**
- `ADMIN_ROLES.SUPER_ADMIN`
- `ADMIN_ROLES.IDEAS_MANAGER`
- `ADMIN_ROLES.EVENTS_MANAGER`
- `ADMIN_ROLES.MEMBERS_MANAGER`
- `ADMIN_STATUS.ACTIVE`
- `ADMIN_STATUS.INACTIVE`

## Key Files Reference

**Architecture:**
- `server/src/main.ts` - Application bootstrap
- `server/src/app.module.ts` - Module imports and global config
- `shared/schema.ts` - Database schema and validation

**Authentication:**
- `server/src/auth/auth.module.ts` - Passport and session config
- `server/src/auth/strategies/authentik.strategy.ts` - OAuth2 strategy
- `server/src/auth/guards/auth.guard.ts` - Session auth guard

**Frontend:**
- `client/src/App.tsx` - Main app component and routing
- `client/src/hooks/` - TanStack Query hooks
- `client/src/lib/branding.ts` - Branding helpers

**Configuration:**
- `client/src/config/branding-core.ts` - Branding configuration
- `docker-compose.services.yml` - Docker services
- `.env.example` - Environment variable template

**Scripts:**
- `scripts/start-dev.sh` - Automated dev environment setup
- `scripts/setup-authentik.sh` - Authentik configuration automation
- `scripts/build-and-copy-to-vps.sh` - VPS deployment with local build
